{
  "version": 3,
  "sources": ["equipment.ts"],
  "sourcesContent": ["/**\n * Equipment Logic - Core business logic for equipment management\n * Handles data operations, state management, and calculations\n */\n\nimport type {\n    EquipmentSlotId,\n    EquipmentData,\n    EquipmentSlotData,\n    EquipmentSlotStats,\n    EquipmentContributions,\n    EquipmentSlotConfig,\n} from '@ts/types/page/equipment/equipment.types';\nimport { STAT, type StatId } from '@ts/types/constants';\nimport { loadoutStore } from '@ts/store/loadout.store';\n\n// ============================================================================\n// EQUIPMENT SLOT DEFINITIONS\n// ============================================================================\n\n/**\n * All equipment slot configurations\n */\nexport const EQUIPMENT_SLOTS: readonly EquipmentSlotConfig[] = [\n    { id: 'head', name: 'Head', hasMainStat: false },\n    { id: 'cape', name: 'Cape', hasMainStat: false },\n    { id: 'chest', name: 'Chest', hasMainStat: false },\n    { id: 'shoulders', name: 'Shoulders', hasMainStat: false },\n    { id: 'legs', name: 'Legs', hasMainStat: false },\n    { id: 'belt', name: 'Belt', hasMainStat: false },\n    { id: 'gloves', name: 'Gloves', hasMainStat: false },\n    { id: 'boots', name: 'Boots', hasMainStat: false },\n    { id: 'ring', name: 'Ring', hasMainStat: true },\n    { id: 'eye-accessory', name: 'Eye Accessory', hasMainStat: true },\n    { id: 'neck', name: 'Neck', hasMainStat: true }\n] as const;\n\n// ============================================================================\n// STATE MANAGEMENT\n// ============================================================================\n\n/**\n * In-memory equipment data store\n */\nlet equipmentData: EquipmentData = {\n    head: null,\n    cape: null,\n    chest: null,\n    shoulders: null,\n    legs: null,\n    belt: null,\n    gloves: null,\n    boots: null,\n    ring: null,\n    neck: null,\n    'eye-accessory': null\n};\n\n// ============================================================================\n// DATA OPERATIONS\n// ============================================================================\n\n/**\n * Get data for a specific equipment slot\n */\nexport function getSlotData(slotId: EquipmentSlotId): EquipmentSlotData | null {\n    return equipmentData[slotId];\n}\n\n/**\n * Get all equipment data\n */\nexport function getAllEquipmentData(): EquipmentData {\n    return equipmentData;\n}\n\n/**\n * Set equipment data for a specific slot\n * Updates both in-memory store and localStorage\n */\nexport function setSlotData(slotId: EquipmentSlotId, data: EquipmentSlotData): void {\n    equipmentData[slotId] = data;\n    saveSlotToStorage(slotId, data);\n}\n\n/**\n * Clear all data for a specific slot\n */\nexport function clearSlotData(slotId: EquipmentSlotId): void {\n    const emptyData: EquipmentSlotData = {\n        name: '',\n        attack: 0,\n        mainStat: 0,\n        statLines: []\n    };\n    setSlotData(slotId, emptyData);\n}\n\n/**\n * Load equipment data from loadout store for all slots\n */\nexport function loadAllEquipmentData(): void {\n    const storeData = loadoutStore.getEquipmentData();\n    EQUIPMENT_SLOTS.forEach(slot => {\n        equipmentData[slot.id] = storeData[slot.id];\n    });\n}\n\n/**\n * Legacy kebab-case to STAT.X.id mapping for migration\n */\nconst LEGACY_STAT_KEY_MAP: Record<string, string> = {\n    'attack': STAT.ATTACK.id,\n    'main-stat': STAT.PRIMARY_MAIN_STAT.id,\n    'defense': STAT.DEFENSE.id,\n    'crit-rate': STAT.CRIT_RATE.id,\n    'crit-damage': STAT.CRIT_DAMAGE.id,\n    'skill-level-1st': STAT.SKILL_LEVEL_1ST.id,\n    'skill-level-2nd': STAT.SKILL_LEVEL_2ND.id,\n    'skill-level-3rd': STAT.SKILL_LEVEL_3RD.id,\n    'skill-level-4th': STAT.SKILL_LEVEL_4TH.id,\n    'skill-level-all': STAT.SKILL_LEVEL_ALL.id,\n    'attack-speed': STAT.ATTACK_SPEED.id,\n    'normal-damage': STAT.NORMAL_DAMAGE.id,\n    'boss-damage': STAT.BOSS_DAMAGE.id,\n    'damage': STAT.DAMAGE.id,\n    'damage-amp': STAT.DAMAGE_AMP.id,\n    'final-damage': STAT.FINAL_DAMAGE.id,\n    'min-damage': STAT.MIN_DAMAGE.id,\n    'max-damage': STAT.MAX_DAMAGE.id,\n};\n\n/**\n * Migrate legacy kebab-case statline types to statId format\n * This actively converts all old format data in storage to the new format\n */\nexport function migrateStatlineFormats(): void {\n    // Check if migration has already completed\n    if (localStorage.getItem('statline-migration-complete')) {\n        return;\n    }\n\n    const storeData = loadoutStore.getEquipmentData();\n    let totalMigrated = 0;\n    const slotsMigrated: EquipmentSlotId[] = [];\n\n    // Batch all updates to minimize localStorage writes\n    const updates: Partial<Record<EquipmentSlotId, EquipmentSlotData>> = {};\n\n    EQUIPMENT_SLOTS.forEach(slot => {\n        const slotData = storeData[slot.id];\n        // Guard against corrupted data - ensure statLines is a valid array\n        if (!slotData || !Array.isArray(slotData.statLines)) return;\n\n        // Check if any statlines need migration (kebab-case contains '-')\n        const needsMigration = slotData.statLines.some(statLine =>\n            statLine && statLine.type && typeof statLine.type === 'string' && statLine.type.includes('-')\n        );\n\n        if (needsMigration) {\n            // Migrate statlines to statId format\n            const migratedStatLines = slotData.statLines.map(statLine => {\n                if (!statLine || !statLine.type || typeof statLine.type !== 'string') {\n                    return statLine; // Skip invalid entries\n                }\n                if (statLine.type.includes('-')) {\n                    // Convert kebab-case to statId using legacy mapping\n                    const statId = LEGACY_STAT_KEY_MAP[statLine.type];\n                    totalMigrated++;\n                    return {\n                        ...statLine,\n                        type: (statId || statLine.type) as StatId // Use statId if mapping exists\n                    };\n                }\n                return statLine;\n            });\n\n            // Queue the update for batching\n            updates[slot.id] = {\n                ...slotData,\n                statLines: migratedStatLines\n            };\n            slotsMigrated.push(slot.id);\n        }\n    });\n\n    // Apply all updates in a batch\n    Object.entries(updates).forEach(([slotId, data]) => {\n        loadoutStore.updateEquipment(slotId as EquipmentSlotId, data!);\n    });\n\n    // Mark migration as complete\n    if (totalMigrated > 0) {\n        localStorage.setItem('statline-migration-complete', 'true');\n        console.log(`[Equipment] Migrated ${totalMigrated} statlines across ${slotsMigrated.length} slots from kebab-case to statId`);\n    }\n}\n\n/**\n * Save a single slot's data via loadout store\n */\nfunction saveSlotToStorage(slotId: EquipmentSlotId, data: EquipmentSlotData): void {\n    loadoutStore.updateEquipment(slotId, data);\n}\n\n/**\n * Create empty slot data with defaults\n */\nexport function createEmptySlotData(hasMainStat: boolean): EquipmentSlotData {\n    return {\n        name: '',\n        attack: 0,\n        mainStat: hasMainStat ? 0 : undefined,\n        statLines: []\n    };\n}\n\n// ============================================================================\n// STAT LINE OPERATIONS\n// ============================================================================\n\n/**\n * Get available stat types for dropdown\n * Uses STAT constant for single source of truth\n */\nexport function getAvailableStats(): Array<{ value: string; label: string }> {\n    return [\n        { value: STAT.ATTACK.id, label: STAT.ATTACK.label },\n        { value: STAT.PRIMARY_MAIN_STAT.id, label: 'Main Stat' },\n        { value: STAT.MAIN_STAT_PCT.id, label: 'Main Stat %' },\n        { value: STAT.DEFENSE.id, label: STAT.DEFENSE.label },\n        { value: STAT.CRIT_RATE.id, label: STAT.CRIT_RATE.label },\n        { value: STAT.CRIT_DAMAGE.id, label: STAT.CRIT_DAMAGE.label },\n        { value: STAT.SKILL_LEVEL_1ST.id, label: STAT.SKILL_LEVEL_1ST.label },\n        { value: STAT.SKILL_LEVEL_2ND.id, label: STAT.SKILL_LEVEL_2ND.label },\n        { value: STAT.SKILL_LEVEL_3RD.id, label: STAT.SKILL_LEVEL_3RD.label },\n        { value: STAT.SKILL_LEVEL_4TH.id, label: STAT.SKILL_LEVEL_4TH.label },\n        { value: STAT.SKILL_LEVEL_ALL.id, label: STAT.SKILL_LEVEL_ALL.label },\n        { value: STAT.ATTACK_SPEED.id, label: STAT.ATTACK_SPEED.label },\n        { value: STAT.NORMAL_DAMAGE.id, label: STAT.NORMAL_DAMAGE.label },\n        { value: STAT.BOSS_DAMAGE.id, label: STAT.BOSS_DAMAGE.label },\n        { value: STAT.DAMAGE.id, label: STAT.DAMAGE.label },\n        { value: STAT.FINAL_DAMAGE.id, label: STAT.FINAL_DAMAGE.label },\n        { value: STAT.MIN_DAMAGE.id, label: STAT.MIN_DAMAGE.label },\n        { value: STAT.MAX_DAMAGE.id, label: STAT.MAX_DAMAGE.label },\n    ];\n}\n\n/**\n * Generate HTML option tags for stat type dropdown\n * Shared function used by both equipment and comparison tabs\n */\nexport function generateStatTypeOptionsHTML(): string {\n    return getAvailableStats()\n        .map(stat => `<option value=\"${stat.value}\">${stat.label}</option>`)\n        .join('');\n}\n\n/**\n * Validate a stat type string is a valid STAT.X.id\n * All stat types are now STAT.X.id values (camelCase format)\n */\nexport function getStatKey(statType: StatId | string): StatId | null {\n    // Check if this is a known STAT.X.id\n    const statEntry = Object.values(STAT).find(stat => stat.id === statType);\n    return statEntry ? (statType as StatId) : null;\n}\n\n// ============================================================================\n// CALCULATIONS\n// ============================================================================\n\n/**\n * Calculate stat contributions from a single equipment slot\n */\nexport function calculateSlotContributions(\n    slotConfig: EquipmentSlotConfig,\n    slotData: EquipmentSlotData | null\n): EquipmentSlotStats | null {\n    if (!slotData) return null;\n\n    // Initialize with attack (using STAT.X.id as key)\n    const stats: Partial<Record<StatId, number>> = {\n        [STAT.ATTACK.id]: slotData.attack || 0\n    };\n\n    // Add main stat if applicable - stored as flat value, maps to mainStatPct for consistency\n    if (slotConfig.hasMainStat && slotData.mainStat !== undefined) {\n        stats[STAT.MAIN_STAT_PCT.id] = slotData.mainStat;\n    }\n\n    // Add stat lines - all stat types are now STAT.X.id values\n    if (slotData.statLines && Array.isArray(slotData.statLines)) {\n        slotData.statLines.forEach(statLine => {\n            const statId = getStatKey(statLine.type);\n            if (statId) {\n                stats[statId] = (stats[statId] || 0) + statLine.value;\n            }\n        });\n    }\n\n    return stats as EquipmentSlotStats;\n}\n\n/**\n * Calculate all stat contributions from equipment\n * Returns contributions keyed by slot ID\n */\nexport function calculateAllContributions(): EquipmentContributions {\n    const contributions: Partial<EquipmentContributions> = {};\n\n    EQUIPMENT_SLOTS.forEach(slot => {\n        contributions[slot.id] = calculateSlotContributions(slot, equipmentData[slot.id]);\n    });\n\n    return contributions as EquipmentContributions;\n}\n\n/**\n * Get slot configuration by ID\n */\nexport function getSlotConfig(slotId: EquipmentSlotId): EquipmentSlotConfig | undefined {\n    return EQUIPMENT_SLOTS.find(slot => slot.id === slotId);\n}\n\n/**\n * Check if a slot exists\n */\nexport function isValidSlot(slotId: string): slotId is EquipmentSlotId {\n    return EQUIPMENT_SLOTS.some(slot => slot.id === slotId);\n}\n"],
  "mappings": "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",
  "names": []
}
