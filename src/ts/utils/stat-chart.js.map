{
  "version": 3,
  "sources": ["stat-chart.ts"],
  "sourcesContent": ["import { CumulativeStatCalculator, ChartPoint } from '@ts/services/stat-calculation-service';\r\nimport { loadoutStore } from '@ts/store/loadout.store.js';\r\nimport { Chart, ChartType, ChartData, ChartOptions } from 'chart.js/auto';\r\nimport { StatCalculationService } from '@ts/services/stat-calculation-service.js';\r\n\r\n// Store chart instances with proper typing\r\nconst statWeightCharts: Record<string, Chart> = {};\r\n\r\n// Toggle stat weight chart visibility\r\nexport function toggleStatChart(statKey: string, statLabel: string, isFlat: boolean = false): void {\r\n    const chartId = `chart-${statKey}`;\r\n    const rowId = `chart-row-${statKey}`;\r\n    const chartRow = document.getElementById(rowId);\r\n\r\n    if (!chartRow) return;\r\n\r\n    // Toggle visibility\r\n    if (chartRow.style.display === 'none') {\r\n        chartRow.style.display = 'table-row';\r\n\r\n        // Create chart if it doesn't exist\r\n        if (!statWeightCharts[chartId]) {\r\n            renderStatChart(statKey, statLabel, isFlat);\r\n        }\r\n    } else {\r\n        chartRow.style.display = 'none';\r\n    }\r\n}\r\n\r\n/**\r\n * Map legacy stat keys to proper STAT enum IDs\r\n * Converts old chart statKey format to standardized STAT IDs\r\n */\r\nfunction mapStatKeyToStatId(statKey: string): string {\r\n    const statKeyMap: Record<string, string> = {\r\n        'attack': 'attack',\r\n        'mainStat': 'mainStat',\r\n        'statDamage': 'mainStatPct',\r\n        'finalDamage': 'finalDamage',\r\n        'attackSpeed': 'attackSpeed',\r\n        'defPenMultiplier': 'defPen',\r\n        'bossDamage': 'bossDamage',\r\n        'normalDamage': 'normalDamage',\r\n    };\r\n\r\n    return statKeyMap[statKey] || statKey;\r\n}\r\n\r\n// Generate chart data for a stat\r\nexport function generateStatChartData(statKey: string, statLabel: string, isFlat: boolean): ChartPoint[] {\r\n    const stats = loadoutStore.getBaseStats();\r\n    const weaponAttackBonus = loadoutStore.getWeaponAttackBonus().totalAttack;\r\n    const monsterType: 'boss' | 'normal' = statKey === 'bossDamage' ? 'boss' :\r\n                       (statKey === 'normalDamage' ? 'normal' : 'boss');\r\n\r\n    const calculator = new CumulativeStatCalculator();\r\n    const numPoints = 50;\r\n    const minIncrease = isFlat ? (statKey === 'attack' ? 500 : 100) : 1;\r\n    const maxIncrease = isFlat ? (statKey === 'attack' ? 15000 : 7500) : 75;\r\n\r\n    calculator.startSeries(stats, { weaponAttackBonus, monsterType });\r\n\r\n    const dataPoints: ChartPoint[] = [];\r\n    let cumulativeIncrease = 0;\r\n\r\n    // Map legacy statKey to proper STAT enum ID\r\n    const statId = mapStatKeyToStatId(statKey);\r\n\r\n    // For flat stats, use fixed step size for uniform increments\r\n    // For percentage stats, distribute evenly across the range\r\n    const stepIncrease = isFlat\r\n        ? (statKey === 'attack' ? 500 : 100)\r\n        : (maxIncrease - minIncrease) / numPoints;\r\n\r\n        let statCalculationService = calculator.statService;\r\n\r\n    for (let i = 0; i <= numPoints; i++) {\r\n        cumulativeIncrease += stepIncrease;\r\n\r\n        // Stop if we exceed max increase for flat stats\r\n        if (isFlat && cumulativeIncrease > maxIncrease) {\r\n            break;\r\n        }\r\n\r\n        // Use new simplified API - no isFlat or currentStep needed\r\n        const result = calculator.nextStep(statId, cumulativeIncrease, statCalculationService);\r\n        statCalculationService = result.statCalculationService;\r\n        dataPoints.push(result.point);\r\n    }\r\n\r\n    return dataPoints;\r\n}\r\n\r\n// Render stat weight chart\r\nexport function renderStatChart(statKey: string, statLabel: string, isFlat: boolean): void {\r\n    const chartId = `chart-${statKey}`;\r\n    const canvas = document.getElementById(chartId) as HTMLCanvasElement | null;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n\r\n    const data = generateStatChartData(statKey, statLabel, isFlat);\r\n\r\n    // Destroy existing chart if it exists\r\n    if (statWeightCharts[chartId]) {\r\n        statWeightCharts[chartId].destroy();\r\n    }\r\n\r\n    // Get theme colors\r\n    const isDark = document.documentElement.classList.contains('dark');\r\n    const textColor = isDark ? '#e5e7eb' : '#1f2937';\r\n    const gridColor = isDark ? '#374151' : '#d1d5db';\r\n\r\n    // Determine the per-unit label based on stat type\r\n    const perUnitLabel = isFlat ? (statKey === 'attack' ? '500' : '100') : '1%';\r\n\r\n    // Create new chart\r\n    statWeightCharts[chartId] = new Chart(ctx, {\r\n        type: 'line' as ChartType,\r\n        data: {\r\n            datasets: [{\r\n                label: `${statLabel} \u2192 DPS Gain per ${perUnitLabel}`,\r\n                data: data,\r\n                borderColor: '#007aff',\r\n                backgroundColor: 'rgba(0, 122, 255, 0.1)',\r\n                borderWidth: 2,\r\n                fill: true,\r\n                tension: 0.1,\r\n                pointRadius: 0\r\n            }]\r\n        } as ChartData<'line'>,\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: true,\r\n            aspectRatio: 3,\r\n            plugins: {\r\n                legend: {\r\n                    display: false\r\n                },\r\n                tooltip: {\r\n                    callbacks: {\r\n                        label: function(context) {\r\n                            const increase = context.parsed.x.toFixed(2);\r\n                            const gainPerUnit = context.parsed.y.toFixed(2);\r\n                            return `At +${increase}${isFlat ? '' : '%'}: ${gainPerUnit}% DPS per ${perUnitLabel} added`;\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            scales: {\r\n                x: {\r\n                    type: 'linear',\r\n                    min: isFlat ? (statKey === 'attack' ? 500 : 100) : 1,\r\n                    title: {\r\n                        display: true,\r\n                        text: `Total Increase in ${statLabel}${isFlat ? '' : ' (%)'}`,\r\n                        color: textColor\r\n                    },\r\n                    ticks: {\r\n                        color: textColor\r\n                    },\r\n                    grid: {\r\n                        color: gridColor\r\n                    }\r\n                },\r\n                y: {\r\n                    title: {\r\n                        display: true,\r\n                        text: `DPS Gain (%) per ${perUnitLabel} Added`,\r\n                        color: textColor\r\n                    },\r\n                    ticks: {\r\n                        color: textColor\r\n                    },\r\n                    grid: {\r\n                        color: gridColor\r\n                    }\r\n                }\r\n            }\r\n        } as ChartOptions<'line'>\r\n    });\r\n}\r\n\r\n/**\r\n * Clears all cached stat weight charts from memory\r\n * Destroys Chart.js instances and removes them from the cache\r\n * Called when stats change to force regeneration with updated data\r\n */\r\nexport function resetCachedCharts(): void {\r\n    for (const chartId in statWeightCharts) {\r\n        if (statWeightCharts[chartId]) {\r\n            statWeightCharts[chartId].destroy();\r\n            delete statWeightCharts[chartId];\r\n        }\r\n    }\r\n}\r\n\r\n// Expose to window for HTML onclick handlers\r\nwindow.toggleStatChart = toggleStatChart;\r\nwindow.resetCachedCharts = resetCachedCharts;\r\n"],
  "mappings": "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",
  "names": []
}
