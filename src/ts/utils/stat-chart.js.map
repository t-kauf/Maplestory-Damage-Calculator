{
  "version": 3,
  "sources": ["stat-chart.ts"],
  "sourcesContent": ["import { CumulativeStatCalculator, ChartPoint } from '@ts/services/stat-calculation-service';\nimport { loadoutStore } from '@ts/store/loadout.store.js';\nimport { Chart, ChartType, ChartData, ChartOptions } from 'chart.js/auto';\nimport { StatCalculationService } from '@ts/services/stat-calculation-service.js';\n\n// Store chart instances with proper typing\nconst statWeightCharts: Record<string, Chart> = {};\n\n// Toggle stat weight chart visibility\nexport function toggleStatChart(statKey: string, statLabel: string, isFlat: boolean = false): void {\n    const chartId = `chart-${statKey}`;\n    const rowId = `chart-row-${statKey}`;\n    const chartRow = document.getElementById(rowId);\n\n    if (!chartRow) return;\n\n    // Toggle visibility\n    if (chartRow.style.display === 'none') {\n        chartRow.style.display = 'table-row';\n\n        // Create chart if it doesn't exist\n        if (!statWeightCharts[chartId]) {\n            renderStatChart(statKey, statLabel, isFlat);\n        }\n    } else {\n        chartRow.style.display = 'none';\n    }\n}\n\n/**\n * Map legacy stat keys to proper STAT enum IDs\n * Converts old chart statKey format to standardized STAT IDs\n */\nfunction mapStatKeyToStatId(statKey: string): string {\n    const statKeyMap: Record<string, string> = {\n        'attack': 'attack',\n        'mainStat': 'mainStat',\n        'statDamage': 'mainStatPct',\n        'finalDamage': 'finalDamage',\n        'attackSpeed': 'attackSpeed',\n        'defPenMultiplier': 'defPen',\n        'bossDamage': 'bossDamage',\n        'normalDamage': 'normalDamage',\n    };\n\n    return statKeyMap[statKey] || statKey;\n}\n\n// Generate chart data for a stat\nexport function generateStatChartData(statKey: string, statLabel: string, isFlat: boolean): ChartPoint[] {\n    const stats = loadoutStore.getBaseStats();\n    const weaponAttackBonus = loadoutStore.getWeaponAttackBonus().totalAttack;\n    const monsterType: 'boss' | 'normal' = statKey === 'bossDamage' ? 'boss' :\n                       (statKey === 'normalDamage' ? 'normal' : 'boss');\n\n    const calculator = new CumulativeStatCalculator();\n    const numPoints = 50;\n    const minIncrease = isFlat ? (statKey === 'attack' ? 500 : 100) : 1;\n    const maxIncrease = isFlat ? (statKey === 'attack' ? 15000 : 7500) : 75;\n\n    calculator.startSeries(stats, { weaponAttackBonus, monsterType });\n\n    const dataPoints: ChartPoint[] = [];\n    let cumulativeIncrease = 0;\n\n    // Map legacy statKey to proper STAT enum ID\n    const statId = mapStatKeyToStatId(statKey);\n\n    // For flat stats, use fixed step size for uniform increments\n    // For percentage stats, distribute evenly across the range\n    const stepIncrease = isFlat\n        ? (statKey === 'attack' ? 500 : 100)\n        : (maxIncrease - minIncrease) / numPoints;\n\n        let statCalculationService = calculator.statService;\n\n    for (let i = 0; i <= numPoints; i++) {\n        cumulativeIncrease += stepIncrease;\n\n        // Stop if we exceed max increase for flat stats\n        if (isFlat && cumulativeIncrease > maxIncrease) {\n            break;\n        }\n\n        // Use new simplified API - no isFlat or currentStep needed\n        const result = calculator.nextStep(statId, cumulativeIncrease, statCalculationService);\n        statCalculationService = result.statCalculationService;\n        dataPoints.push(result.point);\n    }\n\n    return dataPoints;\n}\n\n// Render stat weight chart\nexport function renderStatChart(statKey: string, statLabel: string, isFlat: boolean): void {\n    const chartId = `chart-${statKey}`;\n    const canvas = document.getElementById(chartId) as HTMLCanvasElement | null;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    const data = generateStatChartData(statKey, statLabel, isFlat);\n\n    // Destroy existing chart if it exists\n    if (statWeightCharts[chartId]) {\n        statWeightCharts[chartId].destroy();\n    }\n\n    // Get theme colors\n    const isDark = document.documentElement.classList.contains('dark');\n    const textColor = isDark ? '#e5e7eb' : '#1f2937';\n    const gridColor = isDark ? '#374151' : '#d1d5db';\n\n    // Determine the per-unit label based on stat type\n    const perUnitLabel = isFlat ? (statKey === 'attack' ? '500' : '100') : '1%';\n\n    // Create new chart\n    statWeightCharts[chartId] = new Chart(ctx, {\n        type: 'line' as ChartType,\n        data: {\n            datasets: [{\n                label: `${statLabel} \u2192 DPS Gain per ${perUnitLabel}`,\n                data: data,\n                borderColor: '#007aff',\n                backgroundColor: 'rgba(0, 122, 255, 0.1)',\n                borderWidth: 2,\n                fill: true,\n                tension: 0.1,\n                pointRadius: 0\n            }]\n        } as ChartData<'line'>,\n        options: {\n            responsive: true,\n            maintainAspectRatio: true,\n            aspectRatio: 3,\n            plugins: {\n                legend: {\n                    display: false\n                },\n                tooltip: {\n                    callbacks: {\n                        label: function(context) {\n                            const increase = context.parsed.x.toFixed(2);\n                            const gainPerUnit = context.parsed.y.toFixed(2);\n                            return `At +${increase}${isFlat ? '' : '%'}: ${gainPerUnit}% DPS per ${perUnitLabel} added`;\n                        }\n                    }\n                }\n            },\n            scales: {\n                x: {\n                    type: 'linear',\n                    min: isFlat ? (statKey === 'attack' ? 500 : 100) : 1,\n                    title: {\n                        display: true,\n                        text: `Total Increase in ${statLabel}${isFlat ? '' : ' (%)'}`,\n                        color: textColor\n                    },\n                    ticks: {\n                        color: textColor\n                    },\n                    grid: {\n                        color: gridColor\n                    }\n                },\n                y: {\n                    title: {\n                        display: true,\n                        text: `DPS Gain (%) per ${perUnitLabel} Added`,\n                        color: textColor\n                    },\n                    ticks: {\n                        color: textColor\n                    },\n                    grid: {\n                        color: gridColor\n                    }\n                }\n            }\n        } as ChartOptions<'line'>\n    });\n}\n\n/**\n * Clears all cached stat weight charts from memory\n * Destroys Chart.js instances and removes them from the cache\n * Called when stats change to force regeneration with updated data\n */\nexport function resetCachedCharts(): void {\n    for (const chartId in statWeightCharts) {\n        if (statWeightCharts[chartId]) {\n            statWeightCharts[chartId].destroy();\n            delete statWeightCharts[chartId];\n        }\n    }\n}\n\n// Expose to window for HTML onclick handlers\nwindow.toggleStatChart = toggleStatChart;\nwindow.resetCachedCharts = resetCachedCharts;\n"],
  "mappings": "AAAA,SAAS,gCAA4C;AACrD,SAAS,oBAAoB;AAC7B,SAAS,aAAiD;AAI1D,MAAM,mBAA0C,CAAC;AAG1C,SAAS,gBAAgB,SAAiB,WAAmB,SAAkB,OAAa;AAC/F,QAAM,UAAU,SAAS,OAAO;AAChC,QAAM,QAAQ,aAAa,OAAO;AAClC,QAAM,WAAW,SAAS,eAAe,KAAK;AAE9C,MAAI,CAAC,SAAU;AAGf,MAAI,SAAS,MAAM,YAAY,QAAQ;AACnC,aAAS,MAAM,UAAU;AAGzB,QAAI,CAAC,iBAAiB,OAAO,GAAG;AAC5B,sBAAgB,SAAS,WAAW,MAAM;AAAA,IAC9C;AAAA,EACJ,OAAO;AACH,aAAS,MAAM,UAAU;AAAA,EAC7B;AACJ;AAMA,SAAS,mBAAmB,SAAyB;AACjD,QAAM,aAAqC;AAAA,IACvC,UAAU;AAAA,IACV,YAAY;AAAA,IACZ,cAAc;AAAA,IACd,eAAe;AAAA,IACf,eAAe;AAAA,IACf,oBAAoB;AAAA,IACpB,cAAc;AAAA,IACd,gBAAgB;AAAA,EACpB;AAEA,SAAO,WAAW,OAAO,KAAK;AAClC;AAGO,SAAS,sBAAsB,SAAiB,WAAmB,QAA+B;AACrG,QAAM,QAAQ,aAAa,aAAa;AACxC,QAAM,oBAAoB,aAAa,qBAAqB,EAAE;AAC9D,QAAM,cAAiC,YAAY,eAAe,SAC9C,YAAY,iBAAiB,WAAW;AAE5D,QAAM,aAAa,IAAI,yBAAyB;AAChD,QAAM,YAAY;AAClB,QAAM,cAAc,SAAU,YAAY,WAAW,MAAM,MAAO;AAClE,QAAM,cAAc,SAAU,YAAY,WAAW,OAAQ,OAAQ;AAErE,aAAW,YAAY,OAAO,EAAE,mBAAmB,YAAY,CAAC;AAEhE,QAAM,aAA2B,CAAC;AAClC,MAAI,qBAAqB;AAGzB,QAAM,SAAS,mBAAmB,OAAO;AAIzC,QAAM,eAAe,SACd,YAAY,WAAW,MAAM,OAC7B,cAAc,eAAe;AAEhC,MAAI,yBAAyB,WAAW;AAE5C,WAAS,IAAI,GAAG,KAAK,WAAW,KAAK;AACjC,0BAAsB;AAGtB,QAAI,UAAU,qBAAqB,aAAa;AAC5C;AAAA,IACJ;AAGA,UAAM,SAAS,WAAW,SAAS,QAAQ,oBAAoB,sBAAsB;AACrF,6BAAyB,OAAO;AAChC,eAAW,KAAK,OAAO,KAAK;AAAA,EAChC;AAEA,SAAO;AACX;AAGO,SAAS,gBAAgB,SAAiB,WAAmB,QAAuB;AACvF,QAAM,UAAU,SAAS,OAAO;AAChC,QAAM,SAAS,SAAS,eAAe,OAAO;AAC9C,MAAI,CAAC,OAAQ;AAEb,QAAM,MAAM,OAAO,WAAW,IAAI;AAClC,MAAI,CAAC,IAAK;AAEV,QAAM,OAAO,sBAAsB,SAAS,WAAW,MAAM;AAG7D,MAAI,iBAAiB,OAAO,GAAG;AAC3B,qBAAiB,OAAO,EAAE,QAAQ;AAAA,EACtC;AAGA,QAAM,SAAS,SAAS,gBAAgB,UAAU,SAAS,MAAM;AACjE,QAAM,YAAY,SAAS,YAAY;AACvC,QAAM,YAAY,SAAS,YAAY;AAGvC,QAAM,eAAe,SAAU,YAAY,WAAW,QAAQ,QAAS;AAGvE,mBAAiB,OAAO,IAAI,IAAI,MAAM,KAAK;AAAA,IACvC,MAAM;AAAA,IACN,MAAM;AAAA,MACF,UAAU,CAAC;AAAA,QACP,OAAO,GAAG,SAAS,wBAAmB,YAAY;AAAA,QAClD;AAAA,QACA,aAAa;AAAA,QACb,iBAAiB;AAAA,QACjB,aAAa;AAAA,QACb,MAAM;AAAA,QACN,SAAS;AAAA,QACT,aAAa;AAAA,MACjB,CAAC;AAAA,IACL;AAAA,IACA,SAAS;AAAA,MACL,YAAY;AAAA,MACZ,qBAAqB;AAAA,MACrB,aAAa;AAAA,MACb,SAAS;AAAA,QACL,QAAQ;AAAA,UACJ,SAAS;AAAA,QACb;AAAA,QACA,SAAS;AAAA,UACL,WAAW;AAAA,YACP,OAAO,SAAS,SAAS;AACrB,oBAAM,WAAW,QAAQ,OAAO,EAAE,QAAQ,CAAC;AAC3C,oBAAM,cAAc,QAAQ,OAAO,EAAE,QAAQ,CAAC;AAC9C,qBAAO,OAAO,QAAQ,GAAG,SAAS,KAAK,GAAG,KAAK,WAAW,aAAa,YAAY;AAAA,YACvF;AAAA,UACJ;AAAA,QACJ;AAAA,MACJ;AAAA,MACA,QAAQ;AAAA,QACJ,GAAG;AAAA,UACC,MAAM;AAAA,UACN,KAAK,SAAU,YAAY,WAAW,MAAM,MAAO;AAAA,UACnD,OAAO;AAAA,YACH,SAAS;AAAA,YACT,MAAM,qBAAqB,SAAS,GAAG,SAAS,KAAK,MAAM;AAAA,YAC3D,OAAO;AAAA,UACX;AAAA,UACA,OAAO;AAAA,YACH,OAAO;AAAA,UACX;AAAA,UACA,MAAM;AAAA,YACF,OAAO;AAAA,UACX;AAAA,QACJ;AAAA,QACA,GAAG;AAAA,UACC,OAAO;AAAA,YACH,SAAS;AAAA,YACT,MAAM,oBAAoB,YAAY;AAAA,YACtC,OAAO;AAAA,UACX;AAAA,UACA,OAAO;AAAA,YACH,OAAO;AAAA,UACX;AAAA,UACA,MAAM;AAAA,YACF,OAAO;AAAA,UACX;AAAA,QACJ;AAAA,MACJ;AAAA,IACJ;AAAA,EACJ,CAAC;AACL;AAOO,SAAS,oBAA0B;AACtC,aAAW,WAAW,kBAAkB;AACpC,QAAI,iBAAiB,OAAO,GAAG;AAC3B,uBAAiB,OAAO,EAAE,QAAQ;AAClC,aAAO,iBAAiB,OAAO;AAAA,IACnC;AAAA,EACJ;AACJ;AAGA,OAAO,kBAAkB;AACzB,OAAO,oBAAoB;",
  "names": []
}
