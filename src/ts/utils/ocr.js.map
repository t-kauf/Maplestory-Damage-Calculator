{
  "version": 3,
  "sources": ["ocr.ts"],
  "sourcesContent": ["export function preprocessImage(imageURL: string, applyGrayscale = false, applySharpen = false, applyThreshold = false): Promise<string> {\r\n    return new Promise((resolve) => {\r\n        const img = new Image();\r\n        img.src = imageURL;\r\n        img.onload = () => {\r\n            const canvas = document.createElement('canvas');\r\n            const ctx = canvas.getContext('2d');\r\n\r\n            canvas.width = img.width * 3;\r\n            canvas.height = img.height * 2;\r\n            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\r\n            // Get image data\r\n            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n            const data = imageData.data;\r\n            const contrast = 1.0; // tweak 1.2\u20131.6\r\n            const intercept = 128 * (1 - contrast);\r\n\r\n\r\n            for (let i = 0; i < data.length; i += 4) {\r\n                const r = data[i];\r\n                const g = data[i + 1];\r\n                const b = data[i + 2];\r\n\r\n                const avg = (r + g + b) / 3;\r\n\r\n                // Detect light gray icons\r\n                if (avg > 180) {\r\n                    data[i] = data[i + 1] = data[i + 2] = 255;\r\n                }\r\n            }\r\n\r\n            ctx.putImageData(imageData, 0, 0);\r\n\r\n            if (applyGrayscale) {\r\n                // Convert to grayscale and apply contrast stretching\r\n                for (let i = 0; i < data.length; i += 4) {\r\n                    const r = data[i];\r\n                    const g = data[i + 1];\r\n                    const b = data[i + 2];\r\n\r\n                    // grayscale\r\n                    let gray = 0.299 * r + 0.587 * g + 0.114 * b;\r\n\r\n                    // contrast\r\n                    gray = gray * contrast + intercept;\r\n\r\n                    data[i] = data[i + 1] = data[i + 2] = gray;\r\n                }\r\n                ctx.putImageData(imageData, 0, 0);\r\n            }\r\n\r\n            if (applySharpen) {\r\n                // Apply sharpening\r\n                const sharpenKernel = [\r\n                    0, -1, 0,\r\n                    -1, 5, -1,\r\n                    0, -1, 0\r\n                ];\r\n                const sharpenedData = applyConvolution(imageData, sharpenKernel, canvas.width, canvas.height);\r\n                ctx.putImageData(sharpenedData, 0, 0);\r\n            }\r\n\r\n            if (applyThreshold) {\r\n                // Apply thresholding\r\n                const threshold = 230;\r\n                const thresholdedData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n                const thresholdedPixels = thresholdedData.data;\r\n                for (let i = 0; i < thresholdedPixels.length; i += 4) {\r\n                    const value = thresholdedPixels[i] > threshold ? 255 : 0;\r\n                    thresholdedPixels[i] = thresholdedPixels[i + 1] = thresholdedPixels[i + 2] = value; // Binarize\r\n                }\r\n                ctx.putImageData(thresholdedData, 0, 0);\r\n\r\n            }\r\n            resolve(canvas.toDataURL());\r\n        };\r\n    });\r\n}\r\n\r\nexport async function extractText(imageURL: string, debug = false): Promise<string | undefined> {\r\n    const preprocessedImageURL = await preprocessImage(imageURL, true, true, true);\r\n    const output = document.getElementById('debug-ocr');\r\n\r\n    if (debug) {\r\n        const originalLabel = document.createElement('div');\r\n        originalLabel.innerHTML = `<strong>Original Image:</strong>`;\r\n        output.appendChild(originalLabel);\r\n\r\n        const originalImgElement = document.createElement('img');\r\n        originalImgElement.src = imageURL;\r\n        originalImgElement.style = 'max-width: 100%; margin-bottom: 10px;';\r\n        output.appendChild(originalImgElement);\r\n\r\n        const preprocessedLabel = document.createElement('div');\r\n        preprocessedLabel.innerHTML = `<strong>Preprocessed Image:</strong>`;\r\n        output.appendChild(preprocessedLabel);\r\n\r\n        const preprocessedImgElement = document.createElement('img');\r\n        preprocessedImgElement.src = preprocessedImageURL;\r\n        preprocessedImgElement.style = 'max-width: 100%; margin-bottom: 10px;';\r\n        output.appendChild(preprocessedImgElement);\r\n    }\r\n\r\n    try {\r\n        // @ts-ignore - Tesseract is loaded via CDN\r\n        const worker = await (window as any).Tesseract.createWorker('eng');\r\n\r\n        worker.setParameters({\r\n            tessedit_pageseg_mode: 6,\r\n        })\r\n        const { data: { text } } = await worker.recognize(preprocessedImageURL);\r\n\r\n        if (debug) {\r\n            // Display the extracted text with a label\r\n            const extractedTextLabel = document.createElement('div');\r\n            extractedTextLabel.innerHTML = `<strong>Extracted Text:</strong>`;\r\n            output.appendChild(extractedTextLabel);\r\n\r\n            const extractedTextElement = document.createElement('div');\r\n            extractedTextElement.textContent = text;\r\n            output.appendChild(extractedTextElement);\r\n        }\r\n        return text;\r\n    } catch (error) {\r\n        console.error(error)\r\n    } finally {\r\n        URL.revokeObjectURL(imageURL); // Clean up object URL\r\n    }\r\n}\r\n\r\nfunction applyConvolution(imageData, kernel, width, height) {\r\n    const src = imageData.data;\r\n    const output = new Uint8ClampedArray(src.length);\r\n    const side = Math.round(Math.sqrt(kernel.length));\r\n    const halfSide = Math.floor(side / 2);\r\n\r\n    for (let y = 0; y < height; y++) {\r\n        for (let x = 0; x < width; x++) {\r\n            const dstOffset = (y * width + x) * 4;\r\n            let r = 0, g = 0, b = 0;\r\n\r\n            for (let ky = 0; ky < side; ky++) {\r\n                for (let kx = 0; kx < side; kx++) {\r\n                    const scy = Math.min(height - 1, Math.max(0, y + ky - halfSide));\r\n                    const scx = Math.min(width - 1, Math.max(0, x + kx - halfSide));\r\n                    const srcOffset = (scy * width + scx) * 4;\r\n                    const weight = kernel[ky * side + kx];\r\n                    r += src[srcOffset] * weight;\r\n                    g += src[srcOffset + 1] * weight;\r\n                    b += src[srcOffset + 2] * weight;\r\n                }\r\n            }\r\n\r\n            output[dstOffset] = Math.min(255, Math.max(0, r));\r\n            output[dstOffset + 1] = Math.min(255, Math.max(0, g));\r\n            output[dstOffset + 2] = Math.min(255, Math.max(0, b));\r\n            output[dstOffset + 3] = src[dstOffset + 3]; // Preserve alpha\r\n        }\r\n    }\r\n\r\n    const result = new ImageData(output, width, height);\r\n    return result;\r\n}\r\n\r\nexport function parseBaseStatText(text: string): [string, string][] {\r\n    const displayNamesToInput = {\r\n        \"Attack\": \"attack\",\r\n        \"Defense\": \"defense\",\r\n        \"Critical Rate\": \"critRate\",\r\n        \"Critical Damage\": \"critDamage\",\r\n        \"Attack Speed\": \"attackSpeed\",\r\n        \"STR\": \"str\",\r\n        \"DEX\": \"dex\",\r\n        \"LUK\": \"luk\",\r\n        \"INT\": \"int\",\r\n        \"Stat Prop. Damage\": \"statDamage\",\r\n        \"Damage\": \"damage\",\r\n        \"Damage Amplification\": \"damageAmp\",\r\n        \"Defense Penetration\": \"defPen\",\r\n        \"Boss Monster Damage\": \"bossDamage\",\r\n        \"Normal Monster Damage\": \"normalDamage\",\r\n        \"Min Damage Multiplier\": \"minDamage\", // sometimes broken due to multi line\r\n        \"Max Damage Multiplier\": \"maxDamage\",\r\n        \"1st Job Skill Lv.\": \"skillLevel1st\",\r\n        \"2nd Job Skill Lv.\": \"skillLevel2nd\",\r\n        \"3rd Job Skill Lv.\": \"skillLevel3rd\",\r\n        \"4th Job Skill Lv.\": \"skillLevel4th\",\r\n        \"All Skill Levels\": \"skillLevelAll\",\r\n        \"Final Damage\": \"finalDamage\",\r\n    }\r\n\r\n    const cleanData = text.split(\"\\n\")\r\n        .map(x => x.trim())\r\n        .map(x => x.split(\" i \").join(\" \")) // information hover icon - replaceAll polyfill\r\n        .map(x => x.split(\" ; \").join(\" \")) // information hover icon - replaceAll polyfill\r\n        .filter((x, idx) => !(idx === 0 && !/\\d/.test(x)))\r\n        .filter(x => x)\r\n        .map((x) => { // split into [stat, value]\r\n            if (/^\\d/.test(x)) { // starts with digit, i.e: 1st Job Skill\r\n                const matches = x.match(/^(\\d\\D*)(.*)$/);\r\n                return [matches[1].trim(), matches[2].trim()];\r\n            }\r\n\r\n            const matches = x.match(/^(\\D*)(.*)$/);\r\n            return [matches[1].trim(), matches[2].trim()]\r\n        })\r\n        // for the case where OCR detects multiline stat names incorrectly\r\n        // i.e:\r\n        // Min Damage 147%\r\n        // Multiplier\r\n        .reduce((acc: [string, string][], [label, value]: [string, string]) => {\r\n            if (value === \"\") {\r\n                // merge label into previous element\r\n                if (acc.length > 1) {\r\n                    const prev = acc[acc.length - 1];\r\n                    prev[0] += ` ${label}`;\r\n                }\r\n            } else {\r\n                acc.push([label, value]);\r\n            }\r\n            return acc;\r\n        }, [])\r\n        .map(x => {\r\n            let value = x[1]\r\n            if (value.includes(\"M\") && value.includes(\"K\")) {\r\n                value = value\r\n                    .split(/\\s+/)\r\n                    .reduce((sum, part) => {\r\n                        const value = parseFloat(part);\r\n                        if (part.endsWith(\"M\")) return sum + value * 1_000_000;\r\n                        if (part.endsWith(\"K\")) return sum + value * 1_000;\r\n                        return sum;\r\n                    }, 0)\r\n                    .toString();\r\n            }\r\n            else {\r\n                value = value.split(\",\").join(\"\").split(\"%\").join(\"\")\r\n            }\r\n            return [x[0], value]\r\n        })\r\n\r\n    let matchedData: [string, string][] = cleanData.flatMap(x => {\r\n        const displayName = x[0];\r\n        const value = x[1];\r\n\r\n        // search for longer key match first. i.e: match priority 'Damage Amp' over 'Damage'\r\n        for (const displayNameKey of Object.keys(displayNamesToInput).sort((a, b) => b.length - a.length)) {\r\n            if (displayName.startsWith(displayNameKey)) {\r\n                return [[displayNamesToInput[displayNameKey], value]];\r\n            }\r\n        }\r\n\r\n        return [];\r\n    })\r\n    \r\n    return matchedData;\r\n}\r\n"],
  "mappings": "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",
  "names": ["matches", "value"]
}
