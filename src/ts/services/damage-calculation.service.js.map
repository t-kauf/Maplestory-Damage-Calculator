{
  "version": 3,
  "sources": ["damage-calculation.service.ts"],
  "sourcesContent": ["import { BaseStats } from \"@ts/types\";\r\nimport { getSelectedStageDefense } from \"./stage-defense.service\";\r\n\r\n// Main damage calculation function\r\nexport function calculateDamage(stats: BaseStats, monsterType) {\r\n    // Step 1: Calculate Base Damage\r\n    const totalSkillMastery = stats.MASTERY + (monsterType === 'boss' ? stats.BOSS_MASTERY : 0);\r\n    const baseDamage = stats.ATTACK * (stats.SKILL_COEFFICIENT / 100) * (1 + totalSkillMastery / 100);\r\n\r\n    // Step 2: Calculate Base Hit Damage\r\n    const damageAmpMultiplier = 1 + stats.DAMAGE_AMP / 100;\r\n\r\n    // Get selected stage's defense values\r\n    const stageDefense = getSelectedStageDefense();\r\n\r\n    // Defense Penetration: Reduce enemy's effective defense\r\n    const effectiveDefense = stageDefense.defense * (1 - stats.DEF_PEN / 100);\r\n\r\n    // Defense uses diminishing returns formula: damage dealt = 6000 / (6000 + defense)\r\n    // This ensures defense never reduces damage to zero, even at very high values\r\n    const damageReduction = 6000 / (6000 + effectiveDefense);\r\n\r\n    const monsterDamage = monsterType === 'boss' ? stats.BOSS_DAMAGE : stats.NORMAL_DAMAGE;\r\n\r\n    const finalDamageMultiplier = 1 + (stats.FINAL_DAMAGE / 100);\r\n\r\n    const baseHitDamage = baseDamage *\r\n        (1 + stats.STAT_DAMAGE / 100) *\r\n        (1 + stats.DAMAGE / 100) *\r\n        (1 + monsterDamage / 100) *\r\n        damageAmpMultiplier *\r\n        damageReduction *\r\n        finalDamageMultiplier;\r\n\r\n    // Step 3: Calculate Non-Crit Damage Range\r\n    const nonCritMin = baseHitDamage * (Math.min(stats.MIN_DAMAGE, stats.MAX_DAMAGE) / 100);\r\n    const nonCritMax = baseHitDamage * (stats.MAX_DAMAGE / 100);\r\n    const nonCritAvg = (nonCritMin + nonCritMax) / 2;\r\n\r\n    // Step 4: Calculate Crit Damage\r\n    const critMultiplier = 1 + (stats.CRIT_DAMAGE / 100);\r\n    const critMin = nonCritMin * critMultiplier;\r\n    const critMax = nonCritMax * critMultiplier;\r\n    const critAvg = nonCritAvg * critMultiplier;\r\n\r\n    // Step 5: Calculate Expected Damage\r\n    // Cap critical rate at 100%\r\n    const cappedCritRate = Math.min(stats.CRIT_RATE, 100);\r\n    const critRate = cappedCritRate / 100;\r\n    const expectedDamage = nonCritAvg * (1 - critRate) + critAvg * critRate;\r\n\r\n    // Step 6: Calculate DPS\r\n    // Attack speed uses formula: AS = 150(1 - \u220F(1 - s/150)) with hard cap at 150%\r\n    // Any attack speed over 150% is capped and ignored\r\n    const cappedAttackSpeed = Math.min(stats.ATTACK_SPEED, 150);\r\n    const attackSpeedMultiplier = 1 + (cappedAttackSpeed / 100);\r\n    const dps = expectedDamage * attackSpeedMultiplier;\r\n\r\n    return {\r\n        baseDamage,\r\n        baseHitDamage,\r\n        nonCritMin,\r\n        nonCritMax,\r\n        nonCritAvg,\r\n        critMin,\r\n        critMax,\r\n        critAvg,\r\n        expectedDamage,\r\n        dps,\r\n        damageAmpMultiplier,\r\n        attackSpeedMultiplier,\r\n        finalDamageMultiplier\r\n    };\r\n}"],
  "mappings": "AACA,SAAS,+BAA+B;AAGjC,SAAS,gBAAgB,OAAkB,aAAa;AAE3D,QAAM,oBAAoB,MAAM,WAAW,gBAAgB,SAAS,MAAM,eAAe;AACzF,QAAM,aAAa,MAAM,UAAU,MAAM,oBAAoB,QAAQ,IAAI,oBAAoB;AAG7F,QAAM,sBAAsB,IAAI,MAAM,aAAa;AAGnD,QAAM,eAAe,wBAAwB;AAG7C,QAAM,mBAAmB,aAAa,WAAW,IAAI,MAAM,UAAU;AAIrE,QAAM,kBAAkB,OAAQ,MAAO;AAEvC,QAAM,gBAAgB,gBAAgB,SAAS,MAAM,cAAc,MAAM;AAEzE,QAAM,wBAAwB,IAAK,MAAM,eAAe;AAExD,QAAM,gBAAgB,cACjB,IAAI,MAAM,cAAc,QACxB,IAAI,MAAM,SAAS,QACnB,IAAI,gBAAgB,OACrB,sBACA,kBACA;AAGJ,QAAM,aAAa,iBAAiB,KAAK,IAAI,MAAM,YAAY,MAAM,UAAU,IAAI;AACnF,QAAM,aAAa,iBAAiB,MAAM,aAAa;AACvD,QAAM,cAAc,aAAa,cAAc;AAG/C,QAAM,iBAAiB,IAAK,MAAM,cAAc;AAChD,QAAM,UAAU,aAAa;AAC7B,QAAM,UAAU,aAAa;AAC7B,QAAM,UAAU,aAAa;AAI7B,QAAM,iBAAiB,KAAK,IAAI,MAAM,WAAW,GAAG;AACpD,QAAM,WAAW,iBAAiB;AAClC,QAAM,iBAAiB,cAAc,IAAI,YAAY,UAAU;AAK/D,QAAM,oBAAoB,KAAK,IAAI,MAAM,cAAc,GAAG;AAC1D,QAAM,wBAAwB,IAAK,oBAAoB;AACvD,QAAM,MAAM,iBAAiB;AAE7B,SAAO;AAAA,IACH;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ;AACJ;",
  "names": []
}
