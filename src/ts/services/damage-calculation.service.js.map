{
  "version": 3,
  "sources": ["damage-calculation.service.ts"],
  "sourcesContent": ["import { BaseStats } from \"@ts/types\";\nimport { getSelectedStageDefense } from \"./stage-defense.service\";\n\n// Main damage calculation function\nexport function calculateDamage(stats: BaseStats, monsterType) {\n    // Step 1: Calculate Base Damage\n    const totalSkillMastery = stats.MASTERY + (monsterType === 'boss' ? stats.BOSS_MASTERY : 0);\n    const baseDamage = stats.ATTACK * (stats.SKILL_COEFFICIENT / 100) * (1 + totalSkillMastery / 100);\n\n    // Step 2: Calculate Base Hit Damage\n    const damageAmpMultiplier = 1 + stats.DAMAGE_AMP / 100;\n\n    // Get selected stage's defense values\n    const stageDefense = getSelectedStageDefense();\n\n    // Defense Penetration: Reduce enemy's effective defense\n    const effectiveDefense = stageDefense.defense * (1 - stats.DEF_PEN / 100);\n\n    // Defense uses diminishing returns formula: damage dealt = 6000 / (6000 + defense)\n    // This ensures defense never reduces damage to zero, even at very high values\n    const damageReduction = 6000 / (6000 + effectiveDefense);\n\n    const monsterDamage = monsterType === 'boss' ? stats.BOSS_DAMAGE : stats.NORMAL_DAMAGE;\n\n    const finalDamageMultiplier = 1 + (stats.FINAL_DAMAGE / 100);\n\n    const baseHitDamage = baseDamage *\n        (1 + stats.STAT_DAMAGE / 100) *\n        (1 + stats.DAMAGE / 100) *\n        (1 + monsterDamage / 100) *\n        damageAmpMultiplier *\n        damageReduction *\n        finalDamageMultiplier;\n\n    // Step 3: Calculate Non-Crit Damage Range\n    const nonCritMin = baseHitDamage * (Math.min(stats.MIN_DAMAGE, stats.MAX_DAMAGE) / 100);\n    const nonCritMax = baseHitDamage * (stats.MAX_DAMAGE / 100);\n    const nonCritAvg = (nonCritMin + nonCritMax) / 2;\n\n    // Step 4: Calculate Crit Damage\n    const critMultiplier = 1 + (stats.CRIT_DAMAGE / 100);\n    const critMin = nonCritMin * critMultiplier;\n    const critMax = nonCritMax * critMultiplier;\n    const critAvg = nonCritAvg * critMultiplier;\n\n    // Step 5: Calculate Expected Damage\n    // Cap critical rate at 100%\n    const cappedCritRate = Math.min(stats.CRIT_RATE, 100);\n    const critRate = cappedCritRate / 100;\n    const expectedDamage = nonCritAvg * (1 - critRate) + critAvg * critRate;\n\n    // Step 6: Calculate DPS\n    // Attack speed uses formula: AS = 150(1 - \u220F(1 - s/150)) with hard cap at 150%\n    // Any attack speed over 150% is capped and ignored\n    const cappedAttackSpeed = Math.min(stats.ATTACK_SPEED, 150);\n    const attackSpeedMultiplier = 1 + (cappedAttackSpeed / 100);\n    const dps = expectedDamage * attackSpeedMultiplier;\n\n    return {\n        baseDamage,\n        baseHitDamage,\n        nonCritMin,\n        nonCritMax,\n        nonCritAvg,\n        critMin,\n        critMax,\n        critAvg,\n        expectedDamage,\n        dps,\n        damageAmpMultiplier,\n        attackSpeedMultiplier,\n        finalDamageMultiplier\n    };\n}"],
  "mappings": "AACA,SAAS,+BAA+B;AAGjC,SAAS,gBAAgB,OAAkB,aAAa;AAE3D,QAAM,oBAAoB,MAAM,WAAW,gBAAgB,SAAS,MAAM,eAAe;AACzF,QAAM,aAAa,MAAM,UAAU,MAAM,oBAAoB,QAAQ,IAAI,oBAAoB;AAG7F,QAAM,sBAAsB,IAAI,MAAM,aAAa;AAGnD,QAAM,eAAe,wBAAwB;AAG7C,QAAM,mBAAmB,aAAa,WAAW,IAAI,MAAM,UAAU;AAIrE,QAAM,kBAAkB,OAAQ,MAAO;AAEvC,QAAM,gBAAgB,gBAAgB,SAAS,MAAM,cAAc,MAAM;AAEzE,QAAM,wBAAwB,IAAK,MAAM,eAAe;AAExD,QAAM,gBAAgB,cACjB,IAAI,MAAM,cAAc,QACxB,IAAI,MAAM,SAAS,QACnB,IAAI,gBAAgB,OACrB,sBACA,kBACA;AAGJ,QAAM,aAAa,iBAAiB,KAAK,IAAI,MAAM,YAAY,MAAM,UAAU,IAAI;AACnF,QAAM,aAAa,iBAAiB,MAAM,aAAa;AACvD,QAAM,cAAc,aAAa,cAAc;AAG/C,QAAM,iBAAiB,IAAK,MAAM,cAAc;AAChD,QAAM,UAAU,aAAa;AAC7B,QAAM,UAAU,aAAa;AAC7B,QAAM,UAAU,aAAa;AAI7B,QAAM,iBAAiB,KAAK,IAAI,MAAM,WAAW,GAAG;AACpD,QAAM,WAAW,iBAAiB;AAClC,QAAM,iBAAiB,cAAc,IAAI,YAAY,UAAU;AAK/D,QAAM,oBAAoB,KAAK,IAAI,MAAM,cAAc,GAAG;AAC1D,QAAM,wBAAwB,IAAK,oBAAoB;AACvD,QAAM,MAAM,iBAAiB;AAE7B,SAAO;AAAA,IACH;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ;AACJ;",
  "names": []
}
