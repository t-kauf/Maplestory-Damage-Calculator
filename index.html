<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damage Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js/dist/tesseract.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#007aff',
                            dark: '#0a84ff'
                        },
                        secondary: {
                            light: '#5856d6',
                            dark: '#5e5ce6'
                        },
                        success: {
                            light: '#34c759',
                            dark: '#30d158'
                        },
                        warning: {
                            light: '#ff9500',
                            dark: '#ff9f0a'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Force dark mode - light theme disabled -->
    <script>
        (function() {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            })();
    </script>

    <link rel="stylesheet" href="styles/styles.css">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GKDLXCWZ9R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-GKDLXCWZ9R');
    </script>
</head>

<body class="bg-gray-50 dark:bg-black text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- Donation Message Notification -->
    <div id="donate-notification" class="donate-notification-theme" style="display: none; position: fixed; top: 80px; right: 20px; z-index: 1000; max-width: 400px; border-radius: 12px; padding: 16px 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); animation: slideIn 0.4s ease-out;">
        <div style="display: flex; align-items: start; gap: 12px;">
            <div style="font-size: 24px;">üíù</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95em; line-height: 1.5; margin-bottom: 4px;">
                    Please consider supporting my efforts towards the calculator, what might seem small for you may be big for me :)!
                </div>
            </div>
            <button onclick="dismissDonateNotification()" class="donate-notification-close" style="border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">√ó</button>
        </div>
    </div>

    <!-- Sidebar Backdrop (for mobile) -->
    <div id="sidebar-backdrop" class="sidebar-backdrop" onclick="closeMobileMenu()"></div>

    <!-- Main Sidebar Navigation -->
    <aside id="app-sidebar" class="app-sidebar">
        <nav class="sidebar-nav">
            <!-- Loadout Section -->
            <button class="sidebar-nav-item" data-page="setup" onclick="toggleSubMenu('setup')">
                <span class="sidebar-icon">üéÆ</span>
                <span>Loadout</span>
                <span class="submenu-arrow">‚ñº</span>
            </button>
            <div class="sidebar-submenu" id="submenu-setup">
                <button class="sidebar-submenu-item" data-tab="base-stats" onclick="navigateToTab('setup', 'base-stats')">Base Stats</button>
                <button class="sidebar-submenu-item" data-tab="equipment" onclick="navigateToTab('setup', 'equipment')">Equipment</button>
                <button class="sidebar-submenu-item" data-tab="weapon-levels" onclick="navigateToTab('setup', 'weapon-levels')">Weapon Levels</button>
                <button class="sidebar-submenu-item" data-tab="companions" onclick="navigateToTab('setup', 'companions')">Companions</button>
            </div>

            <!-- Gear Lab Section -->
            <button class="sidebar-nav-item" data-page="optimization" onclick="toggleSubMenu('optimization')">
                <span class="sidebar-icon">üß™</span>
                <span>Gear Lab</span>
                <span class="submenu-arrow">‚ñº</span>
            </button>
            <div class="sidebar-submenu" id="submenu-optimization">
                <button class="sidebar-submenu-item" data-tab="item-comparison" onclick="navigateToTab('optimization', 'item-comparison')">Item Comparison</button>
                <button class="sidebar-submenu-item" data-tab="inner-ability" onclick="navigateToTab('optimization', 'inner-ability')">Inner Ability</button>
                <button class="sidebar-submenu-item" data-tab="artifact-potential" onclick="navigateToTab('optimization', 'artifact-potential')">Artifact Potential</button>
                <button class="sidebar-submenu-item" data-tab="scroll-optimizer" onclick="navigateToTab('optimization', 'scroll-optimizer')">Scrolling</button>
                <button class="sidebar-submenu-item" data-tab="cube-potential" onclick="navigateToTab('optimization', 'cube-potential')">Cube Potential</button>
                <button style="display: none;" class="sidebar-submenu-item" data-tab="stat-breakdown" onclick="navigateToTab('optimization', 'stat-breakdown')">Stat Breakdown</button>
            </div>

            <!-- StatHub Section -->
            <button class="sidebar-nav-item" data-page="predictions" onclick="toggleSubMenu('predictions')">
                <span class="sidebar-icon">üìä</span>
                <span class="stat-hub-logo">Stat<span class="stat-hub-highlight">Hub</span></span>
                <span class="submenu-arrow">‚ñº</span>
            </button>
            <div class="sidebar-submenu" id="submenu-predictions">
                <button class="sidebar-submenu-item" data-tab="stat-tables" onclick="navigateToTab('predictions', 'stat-tables')">Stat Predictions</button>
                <button class="sidebar-submenu-item" data-tab="equivalency" onclick="navigateToTab('predictions', 'equivalency')">Stat Equivalency</button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-dps-summary">
                <span class="sidebar-dps-label">Current DPS</span>
                <span id="sidebar-dps-value" class="sidebar-dps-value">-</span>
            </div>
            <div class="sidebar-footer-actions">
                <button onclick="exportData()" class="sidebar-footer-btn">
                    <span>üìã</span>
                    <span>Copy</span>
                </button>
                <button onclick="importData()" class="sidebar-footer-btn">
                    <span>üì•</span>
                    <span>Paste</span>
                </button>
            </div>
            <button onclick="toggleTheme()" id="theme-toggle-sidebar" class="sidebar-footer-btn" style="display: none !important;">
                <span id="theme-icon-sidebar">üåô</span>
                <span>Toggle Theme</span>
            </button>
            <a href="https://paypal.me/freakehms" target="_blank" rel="noopener noreferrer" class="sidebar-footer-btn donate-btn">
                <span>üíù</span>
                <span>Support Development</span>
            </a>
        </div>
    </aside>

    <!-- Mobile Hamburger Button -->
    <button id="mobile-menu-btn" class="mobile-menu-btn" onclick="openMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Help Sidebar Backdrop (for mobile) -->
    <div id="help-sidebar-backdrop" class="help-sidebar-backdrop" onclick="closeHelpSidebar()"></div>

    <!-- Help Sidebar -->
    <aside id="help-sidebar" class="help-sidebar" style="display: none;">
        <div class="help-sidebar-header">
            <h3 id="help-sidebar-title" class="help-sidebar-title">Help</h3>
            <button id="help-sidebar-close" class="help-close-btn" onclick="closeHelpSidebar()">&times;</button>
        </div>
        <div class="help-sidebar-content" id="help-sidebar-content">
            <!-- Dynamic help content goes here -->
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Page: Loadout -->
        <div id="page-setup" class="page-container">
        <!-- Loadout Content -->
        <div id="character-setup-card" class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow-lg mb-3">
            <div class="optimization-page-header">
                <h1 class="optimization-page-title">Loadout</h1>
            </div>
            <div class="optimization-main-tabs">
                <button class="setup-tab-button optimization-tab-button active" data-tab="base-stats" onclick="switchTabAndUpdateURL('setup', 'base-stats', event)">Base Stats</button>
                <button class="setup-tab-button optimization-tab-button" data-tab="equipment" onclick="switchTabAndUpdateURL('setup', 'equipment', event)">Equipment</button>
                <button class="setup-tab-button optimization-tab-button" data-tab="weapon-levels" onclick="switchTabAndUpdateURL('setup', 'weapon-levels', event)">Weapon Levels</button>
                <button class="setup-tab-button optimization-tab-button" data-tab="companions" onclick="switchTabAndUpdateURL('setup', 'companions', event)">Companions</button>
                <button style="display: none;" class="setup-tab-button optimization-tab-button" data-tab="artifacts" onclick="switchTabAndUpdateURL('setup', 'artifacts', event)">Artifacts</button>
            </div>

            <!-- Base Stats Tab -->
            <div id="setup-base-stats" class="setup-tab-content optimization-tab-content active">
                <div class="bg-transparent p-2">
                    <!-- Class Selector -->
                    <div style="margin-bottom: 8px; padding: 8px; background: var(--background); border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                            <div onclick="selectClass('hero')" id="class-hero" class="class-selector" title="Hero">
                                <img src="media/classes/hero.png" alt="Hero" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Hero</span>
                            </div>
                            <div onclick="selectClass('dark-knight')" id="class-dark-knight" class="class-selector" title="Dark Knight">
                                <img src="media/classes/dk.png" alt="Dark Knight" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Dark Knight</span>
                            </div>
                            <div onclick="selectClass('bowmaster')" id="class-bowmaster" class="class-selector" title="Bowmaster">
                                <img src="media/classes/bowmaster.png" alt="Bowmaster" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Bowmaster</span>
                            </div>
                            <div onclick="selectClass('marksman')" id="class-marksman" class="class-selector" title="Marksman">
                                <img src="media/classes/marksman.png" alt="Marksman" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Marksman</span>
                            </div>
                            <div onclick="selectClass('night-lord')" id="class-night-lord" class="class-selector" title="Night Lord">
                                <img src="media/classes/nl.png" alt="Night Lord" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Night Lord</span>
                            </div>
                            <div onclick="selectClass('shadower')" id="class-shadower" class="class-selector" title="Shadower">
                                <img src="media/classes/shadower.png" alt="Shadower" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Shadower</span>
                            </div>
                            <div onclick="selectClass('arch-mage-il')" id="class-arch-mage-il" class="class-selector" title="Arch Mage (Ice/Lightning)">
                                <img src="media/classes/mage-il.png" alt="Arch Mage (I/L)" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Arch Mage (I/L)</span>
                            </div>
                            <div onclick="selectClass('arch-mage-fp')" id="class-arch-mage-fp" class="class-selector" title="Arch Mage (Fire/Poison)">
                                <img src="media/classes/mage-fp.png" alt="Arch Mage (F/P)" style="width: 48px; height: 48px; object-fit: contain;">
                                <span>Arch Mage (F/P)</span>
                            </div>
                        </div>
                    </div>
                    <div id="debug-ocr"> </div>

                    <!-- Character Level and Job Tier -->
                    <div style="margin-bottom: 8px; padding: 8px; background: var(--background); border: 1px solid var(--border-color); border-radius: 8px;">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" style="align-items: end;">
                            <div class="input-group">
                                <label>Character Level</label>
                                <input type="number" id="character-level" value="0" min="0" max="200" onchange="updateSkillCoefficient(); saveToLocalStorage()">
                            </div>
                            <div class="input-group">
                                <label>Job Tier</label>
                                <div style="display: flex; gap: 8px;">
                                    <button id="job-tier-3rd" class="job-tier-btn active" onclick="selectJobTier('3rd')">
                                        3rd Job
                                    </button>
                                    <button id="job-tier-4th" class="job-tier-btn" onclick="selectJobTier('4th')">
                                        4th Job
                                    </button>
                                </div>
                            </div>
                            <section class="paste-image-section" id="base-stats-paste-image-section" style="max-width: none; margin: 0; display: flex; justify-content: center; align-items: center; position: relative;">
                                <div class="paste-icon" style="font-size: 0.85rem; padding: 8px 12px;"><strong>Auto-fill Stats</strong> üìã</div>
                                <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('stats-autofill')" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; width: 18px; height: 18px;">?</span>
                            </section>
                        </div>
                    </div>

                    <!-- Sub-tabs for Stats and Skill Mastery -->
                    <div class="optimization-sub-tabs" style="display: none;">
                        <button class="optimization-sub-tab-button active" onclick="switchBaseStatsSubTab('character-stats')">Stats</button>
                        <button class="optimization-sub-tab-button" onclick="switchBaseStatsSubTab('skill-mastery')">Skill Mastery</button>
                        <button style="display: none;" class="optimization-sub-tab-button" onclick="switchBaseStatsSubTab('skill-details')">Skill Details</button>
                    </div>

                    <!-- Character Stats Sub-tab -->
                    <div id="base-stats-character-stats" class="base-stats-subtab active">
                    <!-- Two-column container: Stats on left, Target Content on right -->
                    <div class="stats-two-column-container">
                        <!-- Left Column: Stats List -->
                        <div class="stats-list-column">
                            <!-- Core Combat Stats -->
                            <div class="stat-row">
                                <label>Attack</label>
                                <input type="number" id="attack-base" value="500">
                            </div>
                            <div class="stat-row">
                                <label>Defense <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('defense')">?</span></label>
                                <input type="number" id="defense-base" value="0">
                            </div>
                            <div class="stat-row">
                                <label>Critical Rate (%)</label>
                                <input type="number" step="0.1" id="crit-rate-base" value="15">
                            </div>
                            <div class="stat-row">
                                <label>Critical Damage (%)</label>
                                <input type="number" step="0.1" id="crit-damage-base" value="15">
                            </div>
                            <div class="stat-row">
                                <label>Attack Speed (%)</label>
                                <input type="number" step="0.1" id="attack-speed-base" value="0">
                            </div>

                            <!-- Divider -->
                            <div class="stat-divider"></div>

                            <!-- Main Stats (class-based visibility) -->
                            <div class="stat-row" id="str-row">
                                <label>STR</label>
                                <input type="number" id="str-base" value="1000">
                            </div>
                            <div class="stat-row" id="dex-row">
                                <label>DEX</label>
                                <input type="number" id="dex-base" value="0">
                            </div>
                            <div class="stat-row" id="int-row">
                                <label>INT</label>
                                <input type="number" id="int-base" value="1000">
                            </div>
                            <div class="stat-row" id="luk-row">
                                <label>LUK</label>
                                <input type="number" id="luk-base" value="0">
                            </div>

                            <!-- Divider -->
                            <div class="stat-divider"></div>

                            <!-- Damage Modifiers -->
                            <div class="stat-row">
                                <label>Stat Prop. Damage (%)</label>
                                <input type="number" step="0.1" id="stat-damage-base" value="0">
                            </div>
                            <div class="stat-row">
                                <label>Damage (%)</label>
                                <input type="number" step="0.1" id="damage-base" value="10">
                            </div>
                            <div class="stat-row">
                                <label>Damage Amplification (x)</label>
                                <input type="number" step="0.1" id="damage-amp-base" value="0">
                            </div>
                            <div class="stat-row" style="display: none;">
                                <label>Basic Attack Damage (%)</label>
                                <input type="number" step="0.1" id="basic-attack-damage-base" value="0">
                            </div>
                            <div class="stat-row" style="display: none;">
                                <label>Skill Damage (%)</label>
                                <input type="number" step="0.1" id="skill-damage-base" value="0">
                            </div>
                            <div class="stat-row">
                                <label>Defense Penetration (%) <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('def-pen')">?</span></label>
                                <input type="number" step="0.1" id="def-pen-base" value="0">
                            </div>
                            <div class="stat-row">
                                <label>Boss Monster Damage (%)</label>
                                <input type="number" step="0.1" id="boss-damage-base" value="10">
                            </div>
                            <div class="stat-row">
                                <label>Normal Monster Damage (%)</label>
                                <input type="number" step="0.1" id="normal-damage-base" value="0">
                            </div>
                            <div class="stat-row">
                                <label>Min Damage Multiplier (%)</label>
                                <input type="number" step="0.1" id="min-damage-base" value="50">
                            </div>
                            <div class="stat-row">
                                <label>Max Damage Multiplier (%)</label>
                                <input type="number" step="0.1" id="max-damage-base" value="100">
                            </div>
                            <div class="stat-row">
                                <label>Final Damage (%)</label>
                                <input type="number" step="0.1" id="final-damage-base" value="0">
                            </div>

                            <!-- Divider -->
                            <div class="stat-divider"></div>

                            <!-- Skill Levels -->
                            <div class="stat-row">
                                <label>1st Job Skill Level</label>
                                <input type="number" id="skill-level-1st-base" value="0" min="0" onchange="updateSkillCoefficient(); saveToLocalStorage()">
                            </div>
                            <div class="stat-row">
                                <label>2nd Job Skill Level</label>
                                <input type="number" id="skill-level-2nd-base" value="0" min="0" onchange="updateSkillCoefficient(); saveToLocalStorage()">
                            </div>
                            <div class="stat-row">
                                <label>3rd Job Skill Level</label>
                                <input type="number" id="skill-level-3rd-base" value="0" min="0" onchange="updateSkillCoefficient(); saveToLocalStorage()">
                            </div>
                            <div class="stat-row">
                                <label>4th Job Skill Level</label>
                                <input type="number" id="skill-level-4th-base" value="0" min="0" onchange="updateSkillCoefficient(); saveToLocalStorage()">
                            </div>

                            <!-- Divider -->
                            <div class="stat-divider"></div>

                            <!-- Main Stat % -->
                            <div class="stat-row">
                                <label>Current Main Stat % <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('main-stat-pct')">?</span></label>
                                <input type="number" step="0.1" id="main-stat-pct-base" value="0">
                            </div>

                            <!-- Hidden fields that are used elsewhere but kept for compatibility -->
                            <input type="hidden" id="primary-main-stat-base" value="1000">
                            <input type="hidden" id="secondary-main-stat-base" value="0">
                            <input type="hidden" id="skill-mastery-base" value="21">
                            <input type="hidden" id="skill-mastery-boss-base" value="0">
                            <input type="hidden" id="skill-coeff-base" value="0">
                        </div>

                        <!-- Right Column: Skill Mastery and Target Content -->
                        <div class="right-column-stack">
                            <!-- Skill Mastery Section -->
                            <div class="skill-mastery-section">
                            <label style="font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 8px;">Skill Mastery Bonus <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('skill-mastery')">?</span></label>

                            <!-- 3rd Job Mastery Table -->
                            <div id="mastery-table-3rd" style="background: var(--background); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-top: 8px;">
                                <table class="mastery-table">
                                    <thead>
                                        <tr>
                                            <th>Level</th>
                                            <th>All Monsters</th>
                                            <th>Boss Only</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>64</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-64" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-64">10%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>68</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-68" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-68">11%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>72</td>
                                            <td>‚Äî</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-boss-72" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-boss-72">10%</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>76</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-76" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-76">12%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>80</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-80" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-80">13%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>84</td>
                                            <td>‚Äî</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-boss-84" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-boss-84">10%</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>88</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-88" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-88">14%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>92</td>
                                            <td>
                                                <input type="checkbox" id="mastery-3rd-all-92" onchange="updateMasteryBonuses()">
                                                <label for="mastery-3rd-all-92">15%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 4th Job Mastery Table -->
                            <div id="mastery-table-4th" style="background: var(--background); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-top: 8px; display: none;">
                                <table class="mastery-table">
                                    <thead>
                                        <tr>
                                            <th>Level</th>
                                            <th>All Monsters</th>
                                            <th>Boss Only</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>102</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-102" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-102">10%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>106</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-106" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-106">11%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>111</td>
                                            <td>‚Äî</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-boss-111" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-boss-111">10%</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>116</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-116" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-116">12%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>120</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-120" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-120">13%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>124</td>
                                            <td>‚Äî</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-boss-124" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-boss-124">10%</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>128</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-128" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-128">14%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                        <tr>
                                            <td>132</td>
                                            <td>
                                                <input type="checkbox" id="mastery-4th-all-132" onchange="updateMasteryBonuses()">
                                                <label for="mastery-4th-all-132">15%</label>
                                            </td>
                                            <td>‚Äî</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Target Content Type Section -->
                        <div class="target-content-section">
                            <div class="target-content-box">
                                <label class="target-content-label">Target Content Type <span class="info-icon" role="img" aria-label="Info" onclick="openHelpSidebar('target-stage')">?</span></label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px;">
                                    <div onclick="selectContentType('none')" id="content-none" class="content-type-selector" title="Training Dummy">
                                        <span style="font-size: 24px;">üéØ</span>
                                        <span>None</span>
                                    </div>
                                    <div onclick="selectContentType('stageHunt')" id="content-stageHunt" class="content-type-selector" title="Stage Hunt">
                                        <span style="font-size: 24px;">üó∫Ô∏è</span>
                                        <span>Stage Hunt</span>
                                    </div>
                                    <div onclick="selectContentType('chapterBoss')" id="content-chapterBoss" class="content-type-selector" title="Chapter Boss">
                                        <span style="font-size: 24px;">üëë</span>
                                        <span>Chapter Boss</span>
                                    </div>
                                    <div onclick="selectContentType('worldBoss')" id="content-worldBoss" class="content-type-selector" title="World Boss">
                                        <span style="font-size: 24px;">üåç</span>
                                        <span>World Boss</span>
                                    </div>
                                    <div onclick="selectContentType('growthDungeon')" id="content-growthDungeon" class="content-type-selector" title="Growth Dungeon">
                                        <span style="font-size: 24px;">üìà</span>
                                        <span>Growth Dungeon</span>
                                    </div>
                                </div>
                                <!-- Sub-category selector for Stage Hunts and Growth Dungeons -->
                                <select id="target-subcategory" onchange="updateStageDropdown()" style="display: none; margin-bottom: 12px;">
                                    <!-- Populated by JavaScript based on content type -->
                                </select>
                                <!-- Final stage selection -->
                                <select id="target-stage-base" onchange="saveToLocalStorage(); updateAnalysisTabs();" style="display: none;">
                                    <!-- Populated by JavaScript based on content type/subcategory selection -->
                                </select>
                            </div>
                        </div>
                        </div>
                        <!-- End Right Column -->
                    </div>
                    </div>
                    <!-- End Character Stats Sub-tab -->

                    <!-- Skill Details Sub-tab -->
                    <div id="base-stats-skill-details" class="base-stats-subtab" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.05)); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px var(--shadow);">
                            <div style="color: var(--text-primary); font-size: 0.9em; line-height: 1.5;">
                                <strong style="color: var(--accent-primary);">Instructions:</strong> Click on a skill to view its description with calculated values based on your character level.
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 20px;">
                            <!-- Left Panel: Compact Skill Icons -->
                            <div style="background: var(--background); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px;">
                                <!-- Skills -->
                                <div style="margin-bottom: 15px;">
                                    <div style="color: var(--accent-primary); font-size: 0.85em; font-weight: 600; margin-bottom: 8px; text-align: center;">Skills</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap; max-width: 300px;">
                                            <div id="skill-grid-skills-2nd" style="display: contents;"></div>
                                            <div id="skill-grid-skills-3rd" style="display: contents;"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Passives -->
                                <div>
                                    <div style="color: var(--accent-primary); font-size: 0.85em; font-weight: 600; margin-bottom: 8px; text-align: center;">Passives</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap; max-width: 300px;">
                                            <div id="skill-grid-passives-2nd" style="display: contents;"></div>
                                            <div id="skill-grid-passives-3rd" style="display: contents;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Panel: Skill Description -->
                            <div id="skill-description-panel" style="background: linear-gradient(135deg, rgba(0, 122, 255, 0.08), rgba(88, 86, 214, 0.05)); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; height: fit-content; position: sticky; top: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                                    Select a skill to view its details
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Skill Details Sub-tab -->

                </div>
            </div>

            <!-- Equipment Tab -->
            <div id="setup-equipment" class="setup-tab-content optimization-tab-content">
                <!-- Summary Section -->
                <div id="equipment-summary" style="background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(0, 122, 255, 0.05)); border: 2px solid var(--accent-primary); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 16px var(--shadow);">
                    <h3 style="color: var(--accent-primary); margin: 0 0 10px 0; font-size: 1em; font-weight: 700;">Total Equipment Stats</h3>
                    <div id="equipment-summary-content" style="display: flex; flex-wrap: wrap; gap: 6px 10px; font-size: 0.9em; align-items: center; min-height: 24px;">
                        <span style="color: var(--text-secondary);">No equipment configured</span>
                    </div>
                </div>

                <!-- Equipment Slots Grid -->
                <div id="equipment-slots-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px;">
                    <!-- Equipment slots populated by JavaScript -->
                </div>
            </div>

            <!-- Weapon Levels Tab -->
            <div id="setup-weapon-levels" class="setup-tab-content optimization-tab-content">
                <!-- Sub-tab Navigation -->
                <div class="optimization-sub-tabs">
                    <button id="weapon-levels-subtab-button" class="tab-button active" onclick="switchWeaponLevelsTab('weapons-grid')">Weapons Grid</button>
                    <button id="weapon-levels-subtab-button" class="tab-button" onclick="switchWeaponLevelsTab('upgrade-priority')">Upgrade Priority</button>
                </div>

                <!-- Weapons Grid Sub-Tab -->
                <div id="weapon-levels-weapons-grid" class="weapon-levels-subtab active">
                    <!-- Summary Stats -->
                    <div class="wl-summary-stats">
                        <div class="wl-summary-card">
                            <span class="wl-summary-label">Total Inventory Attack %</span>
                            <div class="wl-summary-value" id="total-inventory-attack">0%</div>
                        </div>
                        <div class="wl-summary-card">
                            <span class="wl-summary-label">Equipped Attack %</span>
                            <div class="wl-summary-value" id="equipped-weapon-attack-pct">0%</div>
                        </div>
                        <div class="wl-summary-card">
                            <span class="wl-summary-label">Total Weapon Attack %</span>
                            <div class="wl-summary-value" id="total-weapon-attack">0%</div>
                        </div>
                    </div>

                    <!-- Info Banner -->
                    <div class="wl-info-banner">
                        <div class="wl-info-banner-content">
                            <strong>Instructions:</strong> Click stars to set star rating, enter weapon level. Check the "E" button to equip a weapon. The given inventory attack gain % is how much you'd expect if you spent 10k shards on the given weapon.
                        </div>
                    </div>

                    <!-- No Weapon Equipped Indicator -->
                    <div id="no-weapon-equipped-indicator" class="wl-warning-banner">
                        <span class="wl-warning-banner-icon">‚ö†Ô∏è</span>
                        <span class="wl-warning-banner-text">No Weapon Equipped - Check the "E" button on a weapon to equip it</span>
                    </div>

                    <div id="weapons-grid">
                        <!-- Weapons will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Upgrade Priority Sub-Tab -->
                <div id="weapon-levels-upgrade-priority" class="weapon-levels-subtab" style="display: none;">
                    <!-- Upgrade Priority Chain -->
                    <div id="upgrade-priority-container" class="wl-priority-container">
                        <div class="wl-priority-header">
                            Next 100 Upgrades Priority (Best Inventory Attack Gain)
                        </div>
                        <div id="upgrade-priority-chain" class="wl-priority-chain">
                            <!-- Priority chain will be generated by JavaScript -->
                        </div>

                        <!-- Currency Calculator -->
                        <div class="wl-currency-section">
                            <div class="wl-currency-header">
                                Enter your current upgrade currency to see your optimal target weapon levels
                            </div>
                            <div class="wl-currency-input-group">
                                <label class="wl-currency-label" for="upgrade-currency-input">Upgrade Currency</label>
                                <input type="number" id="upgrade-currency-input" class="wl-currency-input"
                                       placeholder="Enter amount" oninput="calculateCurrencyUpgrades()">
                            </div>
                            <div id="currency-upgrade-results" class="wl-currency-results">
                                <div class="wl-currency-metrics">
                                    <div class="wl-currency-metric">
                                        <span class="wl-currency-metric-label">Total Attack % Gain</span>
                                        <div class="wl-currency-metric-value" id="currency-attack-gain">0%</div>
                                    </div>
                                    <div class="wl-currency-metric">
                                        <span class="wl-currency-metric-label">DPS Gain %</span>
                                        <div class="wl-currency-metric-value" id="currency-dps-gain">0%</div>
                                    </div>
                                </div>
                                <div class="wl-currency-metric-label" style="text-align: center; margin-bottom: 8px;">Upgrade Path:</div>
                                <div id="currency-upgrade-path" class="wl-currency-path">
                                    <!-- Path will be generated -->
                                </div>
                                <button id="apply-upgrade-path-btn" class="wl-apply-button">
                                    Apply Upgrade Path
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Companions Tab -->
            <div id="setup-companions" class="setup-tab-content optimization-tab-content">
                <div style="background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.05)); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px var(--shadow);">
                    <div style="color: var(--text-primary); font-size: 0.9em; line-height: 1.5;">
                        <strong style="color: var(--accent-primary);">Instructions:</strong> Click on a companion to unlock/activate it. Enter the level for each companion. Unlocked companions provide inventory effects (always active), and you can equip companions for additional equip effects. Worth noting that the active abilities or passives that occur when a companion is summoned is not accounted for in any of the values below when providing % gains in DPS. 
                    </div>
                </div>

                <!-- Summary Section -->
                <div id="companions-summary" style="background: var(--background); border: 2px solid var(--accent-primary); border-radius: 12px; padding: 10px 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <h3 style="color: var(--accent-primary); margin: 0; font-size: 1em; font-weight: 700;">Total Inventory Effects:</h3>
                        <div id="companions-summary-content" style="display: flex; flex-wrap: wrap; gap: 6px 10px; font-size: 0.85em; align-items: center;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Companions Grid -->
                <div id="companions-grid-container" class="companions-main-layout">
                    <!-- Icon Grid, Detail Panel, and Presets populated by JS -->
                </div>
            </div>

            <!-- Artifacts Tab -->
            <div id="setup-artifacts" class="setup-tab-content optimization-tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; min-height: 600px;">
                    <!-- Left Panel: Equipped Artifacts -->
                    <div id="artifacts-equipped-panel" style="background: var(--background); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Center Panel: Detail Editor -->
                    <div id="artifacts-detail-panel" style="background: var(--background); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Right Panel: Artifact Grid -->
                    <div id="artifacts-grid-panel" style="background: var(--background); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Page: Character Setup -->

        <!-- Page: Gear Lab -->
        <div id="page-optimization" class="page-container" style="display: none;">
        <!-- Gear Lab Content -->
        <div id="character-optimization-card" class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow-lg mb-3">
            <div class="optimization-page-header">
                <h1 class="optimization-page-title">Gear Lab</h1>
            </div>
            <div class="optimization-main-tabs">
                <button class="optimization-tab-button active" data-tab="item-comparison" onclick="switchTabAndUpdateURL('analysis', 'item-comparison', event); checkPendingSlotNavigation();">Item Comparison</button>
                <button class="optimization-tab-button" data-tab="inner-ability" onclick="switchTabAndUpdateURL('analysis', 'inner-ability', event)">Inner Ability</button>
                <button class="optimization-tab-button" data-tab="artifact-potential" onclick="switchTabAndUpdateURL('analysis', 'artifact-potential', event)">Artifact Potential</button>
                <button class="optimization-tab-button" data-tab="scroll-optimizer" onclick="switchTabAndUpdateURL('analysis', 'scroll-optimizer', event)">Scrolling</button>
                <button class="optimization-tab-button" data-tab="cube-potential" onclick="switchTabAndUpdateURL('analysis', 'cube-potential', event)">Cube Potential</button>
                <button style="display: none;" class="optimization-tab-button" data-tab="stat-breakdown" onclick="switchTabAndUpdateURL('analysis', 'stat-breakdown', event); updateStatBreakdown();">Stat Breakdown</button>
            </div>

            <!-- Item Comparison Tab - Enhanced UI/UX -->
            <div id="optimization-item-comparison" class="optimization-tab-content active">
                <!-- Slot Selector with Improved Visual Hierarchy -->
                <div class="comparison-slot-selector-wrapper">
                    <div class="comparison-slot-selector-inner">
                        <label for="comparison-slot-selector" class="comparison-slot-label">Equipment Slot</label>
                        <select id="comparison-slot-selector" onchange="switchComparisonSlot(this.value)" class="comparison-slot-select" aria-label="Select equipment slot to compare">
                            <option value="head">Head</option>
                            <option value="cape">Cape</option>
                            <option value="chest">Chest</option>
                            <option value="shoulders">Shoulders</option>
                            <option value="legs">Legs</option>
                            <option value="belt">Belt</option>
                            <option value="gloves">Gloves</option>
                            <option value="boots">Boots</option>
                            <option value="ring">Ring</option>
                            <option value="neck">Neck</option>
                            <option value="eye-accessory">Eye Accessory</option>
                        </select>
                    </div>
                </div>

                <!-- Two Column Layout with Improved Spacing -->
                <div class="comparison-columns-wrapper">
                    <!-- Equipped Item Card -->
                    <div class="comparison-column">
                        <h3 class="comparison-column-header comparison-column-header--equipped">Currently Equipped</h3>
                        <div class="equipped-item-card">
                            <div class="equipped-card-header">
                                <div class="equipped-card-title-row">
                                    <span class="equipped-card-title">Equipped Item</span>
                                    <span class="equipped-card-subtitle">(stats in base setup)</span>
                                </div>
                            </div>
                            <div class="equipped-inputs-row">
                                <div class="input-group equipped-input-group">
                                    <label for="equipped-name" class="equipped-label">Name</label>
                                    <input type="text" id="equipped-name" value="Current Item" onchange="saveToLocalStorage()" aria-label="Equipped item name" maxlength="50">
                                </div>
                                <div class="input-group equipped-input-group">
                                    <label for="equipped-attack" class="equipped-label">Attack</label>
                                    <input type="number" id="equipped-attack" value="0" onchange="saveToLocalStorage()" aria-label="Equipped item attack value">
                                </div>
                            </div>
                            <div id="equipped-stats-container" class="equipped-stats-container"></div>
                            <div class="equipped-actions-row">
                                <button onclick="addEquippedStat()" class="equipped-action-btn equipped-action-btn--add" aria-label="Add stat to equipped item">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                    <span>Add Stat</span>
                                </button>
                                <button onclick="unequipItem()" class="equipped-action-btn equipped-action-btn--remove" aria-label="Unequip current item">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                    <span>Unequip</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Items Column -->
                    <div class="comparison-column">
                        <h3 class="comparison-column-header comparison-column-header--comparison">Comparison Items</h3>
                        <!-- Tab Navigation with Enhanced Accessibility -->
                        <div id="comparison-tabs-container" class="comparison-tabs-container" role="tablist" aria-label="Comparison item tabs">
                            <button class="comparison-add-tab-btn" data-type="add-button" onclick="addComparisonItem()" aria-label="Add new comparison item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                                <span>Add Item</span>
                            </button>
                        </div>
                        <!-- Comparison Items Content -->
                        <div id="comparison-items-container" class="comparison-items-container" role="presentation"></div>
                    </div>
                </div>

                <!-- Calculate Button with Enhanced Styling -->
                <button class="comparison-calculate-btn" onclick="calculate()" aria-label="Calculate damage for all comparison items">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    <span>Calculate All</span>
                </button>

                <!-- Results Section with Improved Visual Separation -->
                <div class="comparison-results-section">
                    <h3 class="comparison-results-title">Comparison Results</h3>
                    <div id="results-container" class="comparison-results-grid">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Inner Ability Analysis Tab -->
            <div id="optimization-inner-ability" class="optimization-tab-content">
                <!-- Premium Tab Navigation -->
                <div class="tab-navigation">
                    <button id="inner-ability-tab-button" class="tab-button active" onclick="switchInnerAbilityTab('my-ability-pages')">My Ability Pages</button>
                    <button id="inner-ability-tab-button" class="tab-button" onclick="switchInnerAbilityTab('preset-comparison')">Preset Comparison</button>
                    <button id="inner-ability-tab-button" class="tab-button" onclick="switchInnerAbilityTab('theoretical-best')">Theoretical Best</button>
                </div>

                <!-- My Ability Pages Sub-Tab -->
                <div id="inner-ability-my-ability-pages" class="inner-ability-subtab active">
                    <div id="hero-power-presets-container">
                        <!-- Presets will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Preset Comparison Sub-Tab -->
                <div id="inner-ability-preset-comparison" class="inner-ability-subtab" style="display: none;">
                    <div id="preset-comparison-container">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Theoretical Best Sub-Tab -->
                <div id="inner-ability-theoretical-best" class="inner-ability-subtab" style="display: none;">
                    <div id="theoretical-best-container">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Artifact Potential Tab -->
            <div id="optimization-artifact-potential" class="optimization-tab-content">
                <div id="artifact-potential-container">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Scroll Optimizer Tab -->
            <div id="optimization-scroll-optimizer" class="optimization-tab-content">
                <!-- Sub-tabs for Scrolling -->
                <div class="tab-navigation">
                    <button id="scrolling-tab-button" class="tab-button active" onclick="switchScrollingSubTab('my-slot-performance')">My Slot Performance</button>
                    <button id="scrolling-tab-button" class="tab-button" onclick="switchScrollingSubTab('simulation')">Simulation</button>
                </div>

                <!-- My Slot Performance Sub-Tab -->
                <div id="scrolling-my-slot-performance" class="scrolling-subtab active">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Simulation Sub-Tab -->
                <div id="scrolling-simulation" class="scrolling-subtab" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Cube Potential Tab -->
            <div id="optimization-cube-potential" class="optimization-tab-content">
                <!-- Class Warning Banner -->
                <div id="cube-class-warning" class="optimization-info-banner optimization-info-banner--warning" style="display: none;">
                    <span class="optimization-info-banner-icon">‚ö†Ô∏è</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1em; margin-bottom: 4px;">No Class Selected</div>
                        <div style="color: var(--text-secondary); font-size: 0.9em;">Please select your class in the Hero Power section above to use the Cube Potential calculator. Class selection is needed to properly calculate stat damage gains.</div>
                    </div>
                </div>

                <!-- Flattened Main Tab Navigation -->
                <div id="tab-container-main" class="cube-main-tabs">
                    <button id="cube-main-tab-comparison" class="tab-button active" data-tab="comparison">
                        <span class="cube-tab-label">Comparison</span>
                    </button>
                    <button id="cube-main-tab-rankings" class="tab-button" data-tab="rankings">
                        <span class="cube-tab-label">Best Potentials</span>
                    </button>
                    <button id="cube-main-tab-summary" class="tab-button" data-tab="summary">
                        <span class="cube-tab-label">All Slots Summary</span>
                    </button>
                    <button id="cube-main-tab-simulation" class="tab-button" data-tab="simulation">
                        <span class="cube-tab-label">Simulation</span>
                    </button>
                </div>

                <!-- Comparison Tab Content -->
                <div id="cube-comparison-content" class="cube-tab-content active">
                    <!-- Equipment Slot Selector (inside Comparison tab) -->
                    <div class="cube-slot-selector-wrapper">
                        <label for="cube-slot-selector" class="cube-slot-label">Equipment Slot</label>
                        <div id="cube-slot-selector" class="cube-slot-buttons-container"></div>
                    </div>

                    <!-- Context Controls for Comparison Tab (Potential Type & Rarity) -->
                    <div id="cube-comparison-controls" class="cube-context-controls" style="display: block;">
                        <div class="cube-controls-grid">
                            <!-- Potential Type Toggle -->
                            <div class="cube-control-group">
                                <label class="cube-control-label">Potential Type</label>
                                <div class="cube-potential-type-buttons">
                                    <button id="cube-regular-potential-btn" class="cube-potential-type-btn active" onclick="switchPotentialType('regular')">
                                        <span class="cube-type-icon">‚ú¶</span>
                                        <span>Regular</span>
                                    </button>
                                    <button id="cube-bonus-potential-btn" class="cube-potential-type-btn" onclick="switchPotentialType('bonus')">
                                        <span class="cube-type-icon">‚úß</span>
                                        <span>Bonus</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Rarity Selector -->
                            <div class="cube-control-group">
                                <label for="cube-rarity-selector" class="cube-control-label">Slot Rarity</label>
                                <select id="cube-rarity-selector" class="cube-rarity-select">
                                    <option value="normal">Normal</option>
                                    <option value="rare">Rare</option>
                                    <option value="epic">Epic</option>
                                    <option value="unique">Unique</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="mystic">Mystic</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="cube-comparison-grid">
                        <!-- Set A (Current) Card -->
                        <div class="cube-set-card cube-set-card--a">
                            <div class="cube-set-card-header">
                                <h3 class="cube-set-card-title">Set A (Current)</h3>
                                <span class="cube-set-card-subtitle">Your configured potential</span>
                            </div>

                            <div class="cube-set-card-body">
                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setA-line1-stat">Line 1</label>
                                    <select id="cube-setA-line1-stat" class="cube-line-select"></select>
                                </div>

                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setA-line2-stat">Line 2</label>
                                    <select id="cube-setA-line2-stat" class="cube-line-select"></select>
                                </div>

                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setA-line3-stat">Line 3</label>
                                    <select id="cube-setA-line3-stat" class="cube-line-select"></select>
                                </div>
                            </div>
                        </div>

                        <!-- Set B (Comparison) Card -->
                        <div class="cube-set-card cube-set-card--b">
                            <div class="cube-set-card-header">
                                <h3 class="cube-set-card-title">Set B (Comparison)</h3>
                                <span class="cube-set-card-subtitle">Test alternative potential</span>
                            </div>

                            <div class="cube-set-card-body">
                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setB-line1-stat">Line 1</label>
                                    <select id="cube-setB-line1-stat" class="cube-line-select"></select>
                                </div>

                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setB-line2-stat">Line 2</label>
                                    <select id="cube-setB-line2-stat" class="cube-line-select"></select>
                                </div>

                                <div class="cube-line-input-group">
                                    <label class="cube-line-label" for="cube-setB-line3-stat">Line 3</label>
                                    <select id="cube-setB-line3-stat" class="cube-line-select"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Results -->
                    <div id="cube-comparison-results" class="cube-results-section"></div>
                </div>

                <!-- Best Potentials Tab Content -->
                <div id="cube-rankings-content" class="cube-tab-content">
                    <!-- Controls for Rankings (Independent slot & rarity selectors) -->
                    <div id="cube-rankings-controls" class="cube-context-controls" style="display: block;">
                        <div class="cube-controls-grid">
                            <!-- Slot Selector -->
                            <div class="cube-control-group">
                                <label for="cube-rankings-slot-selector" class="cube-control-label">Equipment Slot</label>
                                <select id="cube-rankings-slot-selector" class="cube-rarity-select">
                                    <!-- Populated by JavaScript -->
                                </select>
                                <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: var(--cube-space-sm);">
                                    Some slots have unique potential lines available only to them
                                </p>
                            </div>

                            <!-- Rarity Selector -->
                            <div class="cube-control-group">
                                <label for="cube-rankings-rarity-selector" class="cube-control-label">Rarity Tier</label>
                                <select id="cube-rankings-rarity-selector" class="cube-rarity-select">
                                    <option value="normal">Normal</option>
                                    <option value="rare">Rare</option>
                                    <option value="epic" selected>Epic</option>
                                    <option value="unique">Unique</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="mystic">Mystic</option>
                                </select>
                                <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: var(--cube-space-sm);">
                                    View best combinations for this rarity (independent of saved config)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="cube-rankings-progress" class="cube-progress-bar" style="display: none;">
                        <div class="cube-progress-track">
                            <div id="cube-rankings-progress-fill" class="cube-progress-fill"></div>
                        </div>
                        <p id="cube-rankings-progress-text" class="cube-progress-text">Calculating best combinations...</p>
                    </div>

                    <!-- Rankings Results -->
                    <div id="cube-rankings-results" class="cube-rankings-results"></div>
                </div>

                <!-- All Slots Summary Tab Content -->
                <div id="cube-summary-content" class="cube-tab-content">
                    <div class="cube-summary-header">
                        <h3 class="cube-summary-title">All Slots Potential Summary</h3>
                        <p class="cube-summary-description">Overview of Set A DPS gains for all equipment slots (Regular and Bonus Potential)</p>
                    </div>

                    <!-- Loading Progress -->
                    <div id="cube-summary-progress" class="cube-progress-bar" style="display: none;">
                        <div class="cube-progress-track">
                            <div id="cube-summary-progress-fill" class="cube-progress-fill"></div>
                        </div>
                        <p id="cube-summary-progress-text" class="cube-progress-text">Loading rankings across all slots...</p>
                    </div>

                    <div id="cube-summary-results" class="cube-summary-results"></div>
                </div>

                <!-- Simulation Tab Content -->
                <div id="cube-simulation-content" class="cube-tab-content">
                    <div class="cube-simulation-header">
                        <h3 class="cube-simulation-title">Cube Potential Optimization Simulator</h3>
                        <p class="cube-simulation-description">Simulates different cubing strategies to find the most efficient approach for maximizing damage across all equipment slots. Uses fictional slots that are all set to normal with 0 tries attempted. This does not account for your current slots or their rarities!</p>
                    </div>

                    <!-- Simulation Controls -->
                    <div class="cube-simulation-controls">
                        <div class="cube-simulation-inputs">
                            <div class="cube-sim-input-group">
                                <label for="simulation-cube-budget" class="cube-sim-label">Cube Budget</label>
                                <input type="number" id="simulation-cube-budget" value="1000" min="100" max="50000" step="100" class="cube-sim-input">
                            </div>
                            <div class="cube-sim-input-group">
                                <label for="simulation-count" class="cube-sim-label">Number of Simulations</label>
                                <input type="number" id="simulation-count" value="1000" min="100" max="10000" step="100" class="cube-sim-input">
                            </div>
                        </div>
                        <button class="cube-sim-run-btn" onclick="runCubeSimulation()" id="cube-simulation-run-btn">
                            <span class="cube-sim-btn-icon">‚ñ∂</span>
                            <span>Run Simulation</span>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div id="cube-simulation-progress" class="cube-progress-bar" style="display: none;">
                        <div class="cube-progress-track">
                            <div id="cube-simulation-progress-fill" class="cube-progress-fill"></div>
                        </div>
                        <p id="cube-simulation-progress-text" class="cube-progress-text">Running simulations...</p>
                    </div>

                    <!-- Results -->
                    <div id="cube-simulation-results" class="cube-simulation-results"></div>
                </div>
            </div>

            <!-- Stat Breakdown Tab -->
            <div id="optimization-stat-breakdown" class="optimization-tab-content">
                <div id="stat-breakdown-content">
                    <!-- Stat breakdown sections will be rendered here -->
                </div>
            </div>
        </div>
        </div>
        <!-- End Page: Character Optimization -->

        <!-- Page: Stat Hub -->
        <div id="page-predictions" class="page-container" style="display: none;">
        <!-- Stat Hub Content -->
        <div id="stat-damage-predictions-card" class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow-lg mb-3">
            <div class="optimization-page-header">
                <h1 class="optimization-page-title">
                    Stat Hub
                </h1>
            </div>

            <div class="optimization-main-tabs">
                <button class="predictions-tab-button optimization-tab-button active" data-tab="stat-tables" onclick="switchTabAndUpdateURL('predictions', 'stat-tables', event)">Stat Predictions</button>
                <button class="predictions-tab-button optimization-tab-button" data-tab="equivalency" onclick="switchTabAndUpdateURL('predictions', 'equivalency', event)">Stat Equivalency</button>
            </div>

            <!-- Stat Predictions Tab -->
            <div id="predictions-stat-tables" class="predictions-tab-content optimization-tab-content active">
                <div id="stat-weights-base"></div>
            </div>

            <!-- Stat Equivalency Tab -->
            <div id="predictions-equivalency" class="predictions-tab-content optimization-tab-content">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 10px; font-size: 1.2em; font-weight: 600;">
                        ‚ú® Stat Equivalency Calculator
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;">
                        Enter a value for any stat below to see what that gain translates to for all other stats. Perfect for comparing upgrade paths and understanding relative stat values.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Input Fields -->
                    <div>
                        <!-- Flat Stats Section -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--accent-primary); font-weight: 700; margin-bottom: 12px; font-size: 1em; text-transform: uppercase; letter-spacing: 0.05em;">Flat Stats</h4>
                            <div class="stats-list-column">
                                <div class="stat-row">
                                    <label>Attack</label>
                                    <input type="number" id="equiv-attack" value="1000" min="0" step="100" oninput="calculateStatEquivalency('attack')">
                                </div>
                                <div class="stat-row">
                                    <label>Main Stat (100 = 1% Stat Dmg)</label>
                                    <input type="number" id="equiv-main-stat" value="500" min="0" step="50" oninput="calculateStatEquivalency('main-stat')">
                                </div>
                            </div>
                        </div>

                        <!-- Percentage Stats Section -->
                        <div>
                            <h4 style="color: var(--accent-primary); font-weight: 700; margin-bottom: 12px; font-size: 1em; text-transform: uppercase; letter-spacing: 0.05em;">Percentage Stats</h4>
                            <div class="stats-list-column">
                                <div class="stat-row">
                                    <label>Skill Coefficient (%)</label>
                                    <input type="number" id="equiv-skill-coeff" value="10" min="0" step="1" oninput="calculateStatEquivalency('skill-coeff')">
                                </div>
                                <div class="stat-row">
                                    <label>Skill Mastery (%)</label>
                                    <input type="number" id="equiv-skill-mastery" value="5" min="0" step="1" oninput="calculateStatEquivalency('skill-mastery')">
                                </div>
                                <div class="stat-row">
                                    <label>Damage (%)</label>
                                    <input type="number" id="equiv-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Final Damage (%) <span class="info-icon" role="img" aria-label="Info" title="Increases to this stat are multiplicative rather than additive.">‚ÑπÔ∏è</span></label>
                                    <input type="number" id="equiv-final-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('final-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Boss Damage (%)</label>
                                    <input type="number" id="equiv-boss-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('boss-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Monster Damage (%)</label>
                                    <input type="number" id="equiv-normal-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('normal-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Main Stat %</label>
                                    <input type="number" id="equiv-stat-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('stat-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Damage Amplification (x)</label>
                                    <input type="number" id="equiv-damage-amp" value="1" min="0" step="0.1" oninput="calculateStatEquivalency('damage-amp')">
                                </div>
                                <div class="stat-row">
                                    <label>Min Damage Multiplier (%)</label>
                                    <input type="number" id="equiv-min-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('min-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Max Damage Multiplier (%)</label>
                                    <input type="number" id="equiv-max-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('max-damage')">
                                </div>

                                <!-- Divider -->
                                <div class="stat-divider"></div>

                                <div class="stat-row">
                                    <label>Critical Rate (%)</label>
                                    <input type="number" id="equiv-crit-rate" value="10" min="0" step="1" oninput="calculateStatEquivalency('crit-rate')">
                                </div>
                                <div class="stat-row">
                                    <label>Critical Damage (%)</label>
                                    <input type="number" id="equiv-crit-damage" value="10" min="0" step="1" oninput="calculateStatEquivalency('crit-damage')">
                                </div>
                                <div class="stat-row">
                                    <label>Attack Speed (%)</label>
                                    <input type="number" id="equiv-attack-speed" value="10" min="0" step="1" oninput="calculateStatEquivalency('attack-speed')">
                                </div>
                                <div class="stat-row">
                                    <label>Defense Penetration (%)</label>
                                    <input type="number" id="equiv-def-pen" value="10" min="0" step="1" oninput="calculateStatEquivalency('def-pen')">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Results Display -->
                    <div style="position: sticky; top: 20px;">
                        <h4 style="color: var(--accent-success); font-weight: 700; margin-bottom: 12px; font-size: 1em; text-transform: uppercase; letter-spacing: 0.05em;">Results</h4>
                        <div id="equivalency-results" style="border-radius: 12px; padding: 20px; min-height: 500px;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 60px 20px;">
                                <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.4;">üìä</div>
                                <p style="font-size: 1.1em;">Enter a value in any stat field to see the equivalent damage gain across all stats.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Page: Stat Damage Predictions -->
    </div>
    <!-- End Main Content -->

    <!-- Import Map for cleaner imports -->
    <script type="importmap">
    {
        "imports": {
            "@core/": "./src/core/",
            "@ui/": "./src/ui/",
            "@utils/": "./src/utils/",
            "@data/": "./src/data/"
        }
    }
    </script>

    <script type="module" src="./src/core/main.js"></script>
</body>

</html>
